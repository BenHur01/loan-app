<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Application Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f7f9fb;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 2rem;
    }
    .container {
        max-width: 800px;
        width: 100%;
        background-color: #fff;
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        padding: 2.5rem;
    }
    .countdown {
        font-weight: bold;
        color: #4f46e5;
    }
    .whatsapp-btn {
        background-color: #25D366;
        color: white;
        font-weight: bold;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: transform 0.2s;
    }
    .whatsapp-btn:hover { transform: scale(1.05); }
</style>
</head>
<body>

<div class="container">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Loan Application Dashboard</h1>
        <p class="text-gray-500 mt-2">Check Your Current Status</p>
    </header>

    <!-- WhatsApp Notice -->
    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-gray-700">
        <p class="mb-2">ðŸ“¢ Please take a screenshot of this dashboard and send it to Sylvester immediately via WhatsApp:</p>
        <a href="https://wa.me/27832004918" target="_blank" class="whatsapp-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5" viewBox="0 0 24 24"><path d="M20.52 3.48a11.83 11.83 0 0 0-16.72 16.72l-1.79 6.54 6.74-1.76a11.88 11.88 0 0 0 16.77-16.77zm-8.7 16.04a9.63 9.63 0 0 1-5.01-1.41l-.36-.22-3.04.79.81-3.05-.23-.36a9.59 9.59 0 1 1 7.83 4.25z"/><path d="M16.54 14.24c-.28-.14-1.65-.81-1.9-.91s-.42-.14-.6.14-.69.91-.85 1.1-.31.21-.59.07c-.28-.14-1.18-.44-2.25-1.39-.83-.74-1.39-1.66-1.55-1.92s-.02-.42.12-.56.28-.31.42-.47.19-.28.28-.47.09-.28.14-.47c.05-.19 0-.35-.02-.49s-.6-1.41-.82-1.93c-.22-.51-.45-.44-.61-.45s-.28-.01-.43-.01a1.55 1.55 0 0 0-1.12.53c-.39.42-1.51 1.48-1.51 3.61s1.55 4.19 1.77 4.48c.22.28 3.06 4.67 7.41 6.55a7.53 7.53 0 0 0 3.44.53 6.28 6.28 0 0 0 3.63-1.52 6.51 6.51 0 0 0 2.03-3.22c.18-.31.16-.57.11-.63-.05-.06-.19-.09-.42-.14s-2.46-.89-2.82-.99z"/></svg>
            WhatsApp Sylvester
        </a>
    </div>

    <!-- Status -->
    <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-gray-700">
        <p class="text-lg font-semibold">Current Status: <span id="currentStatus" class="text-indigo-700">Pending Review</span></p>
        <p class="text-sm text-gray-500 mt-1">We will get back to you within 24 hours.</p>
    </div>

    <!-- Application Details -->
    <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
        <h2 class="text-lg font-semibold mb-4 text-gray-800">Application Details</h2>
        <ul class="space-y-2 text-gray-700">
            <li><strong>ID Number:</strong> <span id="appId">Loading...</span></li>
            <li><strong>Name:</strong> <span id="appName">Loading...</span></li>
            <li><strong>Requested Amount:</strong> R<span id="appRequested">0.00</span></li>
            <li><strong>Amount to be Repaid (50% interest):</strong> R<span id="appRepay">0.00</span></li>
            <li><strong>Due Date:</strong> <span id="appDue">Loading...</span> (<span id="countdown" class="countdown">--:--:--</span>)</li>
        </ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
    const SUPABASE_URL = 'https://kujvvupdqvtkncolhcul.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1anZ2dXBkcXZ0a25jb2xoY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM0MzgsImV4cCI6MjA3OTM3OTQzOH0.VBnQywbTQwwWFLmjUAZggfIWC1_J5opHdFwyqMDD3QE';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const userId = localStorage.getItem('currentUserId');

    async function loadApplication() {
        const { data, error } = await supabase.from('borrowers').select('*').eq('id', userId).single();
        if (error || !data) {
            console.error(error);
            alert('Failed to load application data.');
            return;
        }

        // Fill in details
        document.getElementById('appId').textContent = data.id_number;
        document.getElementById('appName').textContent = data.full_name;
        document.getElementById('appRequested').textContent = data.requested_amount.toFixed(2);

        const repayAmount = data.requested_amount * (1 + data.interest_rate);
        document.getElementById('appRepay').textContent = repayAmount.toFixed(2);

        // Due date - month end
        const today = new Date();
        const dueDate = new Date(today.getFullYear(), today.getMonth()+1, 0); // last day of current month
        document.getElementById('appDue').textContent = dueDate.toLocaleDateString();

        // Status
        document.getElementById('currentStatus').textContent = data.status;

        // Countdown
        const countdownEl = document.getElementById('countdown');
        function updateCountdown() {
            const now = new Date();
            const diff = dueDate - now;
            if(diff <= 0){
                countdownEl.textContent = '00:00:00';
                return;
            }
            const hours = Math.floor(diff/1000/60/60);
            const mins = Math.floor((diff/1000/60)%60);
            const secs = Math.floor((diff/1000)%60);
            countdownEl.textContent = `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        }
        updateCountdown();
        setInterval(updateCountdown,1000);
    }

    loadApplication();
</script>

</body>
</html>
