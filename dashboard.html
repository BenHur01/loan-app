<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Status Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8; /* Light background */
        }
        .content-box {
            max-width: 700px;
            width: 95%;
            padding: 2.5rem;
            background-color: #fff;
            border-radius: 1rem; /* Slightly larger rounded corners */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        .header-line {
            border: 0;
            height: 1px;
            background: #e2e8f0;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.35rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.875rem; /* Increased size */
            letter-spacing: 0.05em;
        }
        /* Specific Status Colors */
        .status-pending { background-color: #fcd34d; color: #78350f; } /* Amber */
        .status-approved { background-color: #a7f3d0; color: #065f46; } /* Emerald */
        .status-rejected { background-color: #fecaca; color: #991b1b; } /* Red */
        .document-link {
            color: #4f46e5;
            text-decoration: underline;
            cursor: pointer;
        }
        /* Responsive Grid for Details */
        @media (max-width: 640px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="main-class-dashboard-layout">

    <main class="content-box">
        <header>
            <h1 class="text-3xl font-extrabold text-gray-900">Loan Application Dashboard</h1>
            <h2 class="text-xl text-gray-600 mt-2">Check Your Current Status</h2>
            <hr class="header-line">
            <p class="text-sm text-red-500 font-medium hidden" id="errorMessage"></p>
        </header>

        <div class="mb-6 p-4 bg-green-50 border-l-4 border-green-500 rounded-lg shadow-md">
            <h4 class="text-lg font-bold text-green-800 flex items-center mb-2">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.53 2h2.94a2 2 0 011.664.89l.812 1.218A2 2 0 0017.07 7H18a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                ACTION REQUIRED: Verify Submission
            </h4>
            <p class="text-gray-700 text-base mb-3">
                Please take a screenshot of the below dashboard page and send it immediately to Sylvester on WhatsApp:
            </p>
            <a href="https://wa.me/27832004918?text=Hi%20Sylvester%2C%20attached%20is%20my%20loan%20dashboard%20screenshot%20for%20verification." 
               target="_blank" 
               class="inline-flex items-center justify-center w-full md:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 transition duration-150">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.04 2C6.58 2 2.1 6.47 2.1 11.93c0 1.74.45 3.39 1.34 4.88l-1.4 5.12 5.25-1.37c1.45.8 3.1 1.24 4.75 1.24 5.46 0 9.94-4.47 9.94-9.94s-4.48-9.94-9.94-9.94zm4.4 13.92c-.22.68-.86 1.48-1.57 1.88-.72.39-1.5.6-2.9.22-.58-.16-1.57-.6-2.07-.8-.48-.2-.84-.26-1.18-.08-.34.18-.7.88-.93 1.13-.23.25-.46.3-.9.1-.4-.18-1.72-.64-3.26-2.07-1.21-1.1-2.02-2.73-2.25-3.13-.22-.4-.03-.64.13-.8.15-.15.34-.2.49-.37.15-.15.22-.22.37-.4.18-.18.15-.34 0-.47-.15-.18-.4-.48-.6-.7-.2-.23-.3-.4-.46-.6-.18-.2-.37-.15-.54-.15-.18-.04-.4-.04-.6-.04s-.47.07-.7.3c-.23.2-.86.85-.86 2.08 0 1.23.88 2.4 1 2.58.18.15 1.74 2.66 4.18 3.66 2.3.9 2.76.78 3.25.72.48-.06 1.57-.64 1.77-1.17.2-.53.2-1.02.13-1.16-.06-.15-.22-.22-.4-.3z"/></svg>
                Chat with Sylvester on WhatsApp
            </a>
        </div>
        <div id="statusContainer" class="space-y-8">
            <div id="loadingMessage" class="text-center p-6 bg-indigo-50 rounded-xl shadow-inner">
                <p class="text-indigo-600 font-semibold text-lg">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading status...
                </p>
            </div>
            
            <div id="noApplicationMessage" class="hidden text-center p-8 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
                <p class="text-lg text-gray-700 font-bold mb-3">No Active Application Found</p>
                <p class="text-gray-500">
                    Your application status is not yet available. Please ensure you have completed the 
                    <a href="agreement.html" class="text-indigo-600 hover:text-indigo-800 font-medium underline transition duration-150">Loan Agreement</a> and 
                    <a href="signup.html" class="text-indigo-600 hover:text-indigo-800 font-medium underline transition duration-150">Application Form</a> first.
                </p>
            </div>

            <div id="loanDetails" class="hidden">
                <div class="mb-6 p-4 border-l-4 border-indigo-500 bg-indigo-50 rounded-r-lg shadow-sm">
                    <h4 class="text-lg font-semibold text-indigo-700">Current Status:</h4>
                    <div id="detailStatus" class="mt-1 text-2xl font-extrabold">
                        </div>
                </div>

                <h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Application Details</h3>

                <div class="detail-grid grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 p-4 rounded-lg">
                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">ID Number:</div>
                        <div id="detailID" class="text-gray-800 font-semibold"></div>
                    </div>
                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">Name:</div>
                        <div id="detailName" class="text-gray-800 font-semibold truncate"></div>
                    </div>

                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">Requested Amount:</div>
                        <div id="detailAmount" class="text-green-600 font-extrabold"></div>
                    </div>

                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">Repayment Period:</div>
                        <div id="detailRepayment" class="text-gray-800 font-semibold"></div>
                    </div>
                    
                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">Interest Rate:</div>
                        <div id="detailInterest" class="text-red-500 font-semibold"></div>
                    </div>
                </div>

                <div id="repaymentCountdown" class="mt-8 p-4 bg-red-50 border-2 border-red-200 rounded-lg shadow-md hidden">
                    <h4 class="text-xl font-semibold text-red-700 flex items-center mb-2">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Repayment Due In:
                    </h4>
                    <p id="countdownDisplay" class="text-3xl font-extrabold text-red-900"></p>
                </div>


                <h4 class="text-xl font-semibold mt-8 mb-3 text-gray-800 border-b pb-2">Submitted Documents</h4>
                <div id="documentLinks" class="space-y-2 text-sm text-gray-700 p-4 bg-gray-50 rounded-lg">
                    </div>
                
                <div id="statusMessage" class="mt-6 p-4 rounded-lg font-medium hidden">
                    </div>
            </div>
        </div>
        
        <div class="mt-8 text-center">
            <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium transition duration-150">Go back to Home</a>
        </div>
    </main>

    <script type="module">
        // Import Supabase Client
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        // Supabase configuration (as defined in previous steps)
        const SUPABASE_URL = 'https://kujvvupdqvtkncolhcul.supabase.co';
        const SUPABASE_ANON_KEY =
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1anZ2dXBkcXZ0a25jb2xoY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM0MzgsImV4cCI6MjA3OTM3OTQzOH0.VBnQywbTQwwWFLmjUAZggfIWC1_J5opHdFwyqMDD3QE';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /**
         * Fetches borrower status from Supabase based on ID number.
         * @param {string} idNumber 
         * @returns {Promise<Object | null>}
         */
        async function lookupBorrowerStatus(idNumber){
            if (!idNumber) return null;
            try {
                const { data, error } = await supabase.from('borrowers')
                    .select('id_number, full_name, status, requested_amount, interest_rate, repayment_period, date_submitted, document_id_url, document_address_url, document_bank_url, document_selfie_url')
                    .eq('id_number', idNumber).single();
                
                // PGRST116 means no rows found (ID not in database)
                if (error && error.code!=='PGRST116') { 
                    console.error("Supabase Error:", error); 
                    return null; 
                }
                return data || null;
            } catch(e){ 
                console.error("Lookup Exception:", e); 
                return null; 
            }
        }

        /**
         * Calculates and updates the countdown timer.
         * @param {string} submissionDateStr ISO string of submission date.
         * @param {number} periodDays The repayment period in days (e.g., 30).
         */
        function startCountdown(submissionDateStr, periodDays) {
            const countdownDiv = document.getElementById('repaymentCountdown');
            const display = document.getElementById('countdownDisplay');

            // Calculate the due date (submission date + repayment period)
            const submissionDate = new Date(submissionDateStr);
            const dueDate = new Date(submissionDate.getTime() + (periodDays * 24 * 60 * 60 * 1000));
            
            // Immediately show the countdown element
            countdownDiv.classList.remove('hidden');

            const updateTimer = () => {
                const now = new Date().getTime();
                const distance = dueDate.getTime() - now;

                if (distance < 0) {
                    clearInterval(timerInterval);
                    display.innerHTML = "<strong>OVERDUE</strong> - Please contact support immediately.";
                    countdownDiv.classList.replace('bg-red-50', 'bg-red-200'); // Make it stand out more
                    return;
                }

                // Time calculations for days, hours, minutes and seconds
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

                display.innerHTML = `
                    <span class="text-4xl">${days}</span> Days :
                    <span class="text-4xl">${String(hours).padStart(2, '0')}</span> Hrs :
                    <span class="text-4xl">${String(minutes).padStart(2, '0')}</span> Mins
                `;
                
                // Optional: Change color when approaching deadline
                if (days < 5 && distance > 0) {
                    countdownDiv.classList.replace('bg-red-50', 'bg-orange-100');
                }
            };

            // Run update timer immediately, then every minute (60,000ms) for efficiency
            updateTimer();
            const timerInterval = setInterval(updateTimer, 60000);
        }


        // Logic for the Dashboard Page
        document.addEventListener('DOMContentLoaded', async () => {
            const userId = localStorage.getItem('currentUserId');
            const loadingMessage = document.getElementById('loadingMessage');
            const noApplicationMessage = document.getElementById('noApplicationMessage');
            const loanDetails = document.getElementById('loanDetails');
            const statusMessageDiv = document.getElementById('statusMessage');

            if (!userId) {
                loadingMessage.classList.add('hidden');
                noApplicationMessage.classList.remove('hidden');
                return;
            }

            const statusData = await lookupBorrowerStatus(userId);
            loadingMessage.classList.add('hidden');

            if (!statusData) {
                noApplicationMessage.classList.remove('hidden');
                return;
            }

            // Destructure data
            const { 
                status, 
                full_name, 
                requested_amount, 
                repayment_period, 
                interest_rate, 
                date_submitted, // NEW: Retrieved submission date
                document_id_url, 
                document_address_url, 
                document_bank_url,
                document_selfie_url
            } = statusData;

            // --- 1. Display Core Details ---
            document.getElementById('detailName').textContent = full_name;
            document.getElementById('detailID').textContent = userId;
            document.getElementById('detailAmount').textContent = `R${requested_amount.toFixed(2)}`;
            document.getElementById('detailRepayment').textContent = `${repayment_period} days`;
            document.getElementById('detailInterest').textContent = `${(parseFloat(interest_rate) * 100).toFixed(2)}%`;
            
            // --- 2. Display Status Badge ---
            let statusClass = 'status-pending';
            let messageContent = '';
            let messageBg = '';

            if (status === 'approved') {
                statusClass = 'status-approved';
                messageBg = 'bg-green-100 border-green-500 text-green-800';
                messageContent = `Congratulations! Your loan of R${requested_amount.toFixed(2)} has been APPROVED. The funds will be transferred to your bank account within 24 hours.`;
                // Start countdown only for approved loans
                if (date_submitted && repayment_period) {
                    startCountdown(date_submitted, repayment_period);
                }
            } else if (status === 'rejected') {
                statusClass = 'status-rejected';
                messageBg = 'bg-red-100 border-red-500 text-red-800';
                messageContent = `Your loan application has been REJECTED at this time. This decision is based on a review of the submitted documentation and eligibility criteria.`;
            } else {
                // Pending
                statusClass = 'status-pending'; // Ensure status is explicitly set to pending for visual state
                messageBg = 'bg-yellow-100 border-yellow-500 text-yellow-800';
                messageContent = `Your application is currently PENDING review by our finance team. We will update you with a final decision within 48 hours. Thank you for your patience.`;
            }
            
            document.getElementById('detailStatus').innerHTML = `
                <span class="status-badge ${statusClass}">${status}</span>
            `;

            // Display dynamic status message
            statusMessageDiv.className = `mt-6 p-4 rounded-lg font-medium border-l-4 ${messageBg}`;
            statusMessageDiv.innerHTML = `<p>${messageContent}</p>`;
            statusMessageDiv.classList.remove('hidden');


            // --- 3. Display Document Confirmation ---
            const checkIcon = '&#10003;'; // Check mark
            const crossIcon = '&#10007;'; // Cross mark
            const infoIcon = '&#x2139;'; // Information icon

            // Standard compulsory document check
            const getCompulsoryDocStatus = (url, name) => {
                const icon = url ? checkIcon : crossIcon;
                const color = url ? 'text-green-600' : 'text-red-500';
                const text = url ? 'Upload Confirmed' : 'Missing (Compulsory)';
                return `<p class="flex justify-between">
                            <span class="font-bold">${name}:</span> 
                            <span class="${color}">${icon} ${text}</span>
                        </p>`;
            };

            // Specific optional document check
            const getOptionalDocStatus = (url, name) => {
                const icon = url ? checkIcon : infoIcon;
                const color = url ? 'text-green-600' : 'text-yellow-600';
                const text = url ? 'Upload Confirmed' : 'Not Provided (Optional)';
                return `<p class="flex justify-between">
                            <span class="font-bold">${name}:</span> 
                            <span class="${color}">${icon} ${text}</span>
                        </p>`;
            };

            document.getElementById('documentLinks').innerHTML = 
                getCompulsoryDocStatus(document_id_url, 'ID Document') +
                getOptionalDocStatus(document_bank_url, 'Bank Statement') +
                getCompulsoryDocStatus(document_address_url, 'Proof of Address') +
                getCompulsoryDocStatus(document_selfie_url, 'Live Selfie');

            loanDetails.classList.remove('hidden');
        });

    </script>
</body>
</html>

