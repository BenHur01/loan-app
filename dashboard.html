<!-- 
  Dashboard HTML for the Loan Application.
  This file includes all HTML, Tailwind CSS, and JavaScript logic 
  for Firebase authentication, data fetching, and the countdown timer.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Status Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-tag {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 600;
            display: inline-block;
        }
        .status-APPROVED {
            background-color: #d1fae5; /* Light Green */
            color: #065f46; /* Dark Green */
        }
        .status-PENDING {
            background-color: #fef3c7; /* Light Yellow */
            color: #b45309; /* Dark Orange */
        }
        .status-REJECTED {
            background-color: #fee2e2; /* Light Red */
            color: #991b1b; /* Dark Red */
        }
        .detail-label {
            font-weight: 600;
            color: #4b5563;
        }
        .detail-value {
            font-weight: 700;
            color: #1f2937;
        }
        /* Custom styles for the countdown component */
        #countdown-container {
            transition: all 0.3s ease;
        }
        .countdown-segment {
            background-color: #1f2937;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            line-height: 1;
        }
        .countdown-number {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .countdown-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            opacity: 0.8;
            margin-top: 4px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Loan Status Dashboard</h1>
        </header>

        <div id="loading" class="text-center p-8 text-gray-500">Loading application data...</div>

        <div id="dashboard-content" class="hidden">
            <!-- Loan Status Section -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Current Status</h2>
                <div id="status-display" class="status-tag status-PENDING">Loading...</div>
            </div>

            <!-- Application Details Section -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Application Details</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8">
                    <!-- Row 1 -->
                    <div>
                        <div class="detail-label">ID Number</div>
                        <div id="detail-id" class="detail-value">---</div>
                    </div>
                    <div>
                        <div class="detail-label">Name</div>
                        <div id="detail-name" class="detail-value">---</div>
                    </div>

                    <!-- Row 2 -->
                    <div>
                        <div class="detail-label">Requested Amount</div>
                        <div id="detail-requested" class="detail-value text-green-600">---</div>
                    </div>
                    <div>
                        <div class="detail-label">Final Amount to be Repaid</div>
                        <div id="detail-final" class="detail-value text-red-600">---</div>
                    </div>

                    <!-- Row 3: Repayment Due Date -->
                    <div>
                        <div class="detail-label">Repayment Due Date (30 Days Fixed)</div>
                        <div id="detail-due-date" class="detail-value">---</div>
                    </div>
                    <div>
                        <div class="detail-label">Interest Rate</div>
                        <div id="detail-interest" class="detail-value">---</div>
                    </div>
                </div>

                <!-- NEW: Countdown Timer Section (only visible if APPROVED) -->
                <div id="countdown-container" class="mt-8 pt-6 border-t border-gray-100 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Repayment Due In:</h3>
                    <div id="countdown" class="flex space-x-4">
                        <!-- Segments will be populated by JS -->
                    </div>
                    <div id="overdue-message" class="hidden mt-4 text-lg font-bold text-red-600">
                        Payment is now overdue.
                    </div>
                </div>
                <!-- END NEW -->
            </div>

            <!-- Submitted Documents Section -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Submitted Documents</h2>
                <div class="space-y-3" id="documents-list">
                    <!-- Documents will be populated by JS -->
                    <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                        <span class="text-gray-600">ID Document:</span>
                        <span id="doc-id" class="text-sm font-medium text-red-500">Missing</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                        <span class="text-gray-600">Bank Statement:</span>
                        <span id="doc-bank" class="text-sm font-medium text-red-500">Missing</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                        <span class="text-gray-600">Proof of Address:</span>
                        <span id="doc-address" class="text-sm font-medium text-red-500">Missing</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                        <span class="text-gray-600">Live Selfie:</span>
                        <span id="doc-selfie" class="text-sm font-medium text-red-500">Missing</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let countdownInterval = null; // To hold the setInterval reference

        // --- Utility Functions ---

        /**
         * Formats a number to currency string (e.g., 700.00 -> R700.00)
         * @param {number} amount 
         * @returns {string}
         */
        const formatCurrency = (amount) => {
            if (typeof amount !== 'number') return '---';
            return 'R' + amount.toFixed(2);
        };

        /**
         * Gets the due date timestamp and formatted string (last day of the current month).
         * @returns {{timestamp: number, displayDate: string}}
         */
        const getFixedRepaymentDueDate = () => {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();

            // 1. Get the first day of the *next* month
            const dueDate = new Date(year, month + 1, 1);
            
            // 2. Set the date back by one day to get the last day of the current month
            dueDate.setDate(dueDate.getDate() - 1);

            // 3. Set the time to the last second of that day
            dueDate.setHours(23, 59, 59, 999);

            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            const displayDate = dueDate.toLocaleDateString('en-GB', options);

            return {
                timestamp: dueDate.getTime(),
                displayDate: displayDate
            };
        };


        // --- Countdown Timer Logic ---

        /**
         * Starts the countdown timer to the specified due date timestamp.
         * @param {number} dueDateTimestamp - The deadline in milliseconds since the epoch.
         */
        const startCountdown = (dueDateTimestamp) => {
            // Clear any existing interval to prevent overlap
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            const countdownEl = document.getElementById('countdown');
            const overdueEl = document.getElementById('overdue-message');
            
            // Function to calculate and update the timer display
            const updateTimer = () => {
                const now = new Date().getTime();
                const distance = dueDateTimestamp - now;

                if (distance < 0) {
                    // Time is up
                    clearInterval(countdownInterval);
                    countdownEl.innerHTML = '';
                    countdownEl.classList.add('hidden');
                    overdueEl.classList.remove('hidden');
                    return;
                }

                overdueEl.classList.add('hidden');
                countdownEl.classList.remove('hidden');

                // Calculate time units
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                // Modulo for hours: remaining milliseconds after calculating days
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                // Modulo for minutes: remaining milliseconds after calculating hours
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                
                // Format the output HTML
                countdownEl.innerHTML = `
                    <div class="countdown-segment">
                        <div class="countdown-number">${days.toString().padStart(2, '0')}</div>
                        <div class="countdown-label">Days</div>
                    </div>
                    <div class="countdown-segment">
                        <div class="countdown-number">${hours.toString().padStart(2, '0')}</div>
                        <div class="countdown-label">Hours</div>
                    </div>
                    <div class="countdown-segment">
                        <div class="countdown-number">${minutes.toString().padStart(2, '0')}</div>
                        <div class="countdown-label">Minutes</div>
                    </div>
                `;
            };

            // Run immediately and then every minute (60,000 milliseconds)
            updateTimer(); 
            countdownInterval = setInterval(updateTimer, 60000); 
        };

        // --- Data Handling and Firestore Setup ---

        /**
         * Handles the real-time data from Firestore.
         * @param {object} docData - The application document data.
         */
        const handleApplicationData = (docData) => {
            const statusDisplayEl = document.getElementById('status-display');
            const countdownContainerEl = document.getElementById('countdown-container');
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('dashboard-content');
            
            // Show content, hide loading
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

            // 1. Update Loan Status
            const status = docData.status || 'PENDING';
            statusDisplayEl.textContent = status;
            statusDisplayEl.className = `status-tag status-${status}`;

            // 2. Calculate Repayment Details
            const requestedAmount = docData.requestedAmount || 0;
            // 50% interest rate
            const interestRate = 0.50; 
            const finalAmount = requestedAmount * (1 + interestRate);

            // 3. Determine Due Date
            const { timestamp: dueDateTimestamp, displayDate: displayDateString } = getFixedRepaymentDueDate();
            document.getElementById('detail-due-date').textContent = displayDateString;
            
            // 4. Update Details
            document.getElementById('detail-id').textContent = docData.idNumber || 'N/A';
            document.getElementById('detail-name').textContent = docData.name || 'N/A';
            document.getElementById('detail-requested').textContent = formatCurrency(requestedAmount);
            document.getElementById('detail-final').textContent = formatCurrency(finalAmount);
            document.getElementById('detail-interest').textContent = `${(interestRate * 100).toFixed(2)}%`;
            
            // 5. Document Status
            const docs = docData.documents || {};
            const checkIcon = '<span class="text-green-500 font-bold ml-2">&#10003; Upload Confirmed</span>';
            const missingText = '<span class="text-red-500 font-bold ml-2">Missing</span>';

            document.getElementById('doc-id').innerHTML = docs.id ? checkIcon : missingText;
            document.getElementById('doc-bank').innerHTML = docs.bank ? checkIcon : missingText;
            document.getElementById('doc-address').innerHTML = docs.address ? checkIcon : missingText;
            document.getElementById('doc-selfie').innerHTML = docs.selfie ? checkIcon : missingText;

            // 6. Handle Countdown Timer visibility and start
            if (status === 'APPROVED') {
                countdownContainerEl.classList.remove('hidden');
                startCountdown(dueDateTimestamp);
            } else {
                countdownContainerEl.classList.add('hidden');
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
            }
        };

        /**
         * Initializes Firebase and sets up the data listener.
         */
        const initFirebaseAndListener = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserSessionPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth to settle and get the final user ID
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // Path: /artifacts/{appId}/users/{userId}/loanApplication/data
                        const appDocRef = doc(db, 
                            'artifacts', appId, 
                            'users', userId, 
                            'loanApplication', 'data');
                        
                        // Set up the real-time listener (onSnapshot)
                        onSnapshot(appDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                console.log("Current data:", docSnap.data());
                                handleApplicationData(docSnap.data());
                            } else {
                                console.log("No application data found, initializing default.");
                                // Initialize default data if none exists
                                handleApplicationData({
                                    status: 'PENDING',
                                    idNumber: '8701235678975',
                                    name: 'Son of Hur',
                                    requestedAmount: 700.00,
                                    documents: {
                                        id: true, 
                                        bank: true, 
                                        address: true, 
                                        selfie: true 
                                    }
                                });
                            }
                        }, (error) => {
                            console.error("Error listening to document:", error);
                            document.getElementById('loading').textContent = `Error loading data: ${error.message}`;
                        });
                    } else {
                        console.log("No user signed in.");
                        // Handle the state where authentication failed
                        document.getElementById('loading').textContent = "Authentication failed. Please refresh.";
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading').textContent = `Initialization Error: ${error.message}`;
            }
        };

        // Initialize on window load
        window.onload = initFirebaseAndListener;
    </script>
</body>
</html>
