<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Status Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8; /* Light background */
        }
        .content-box {
            max-width: 700px;
            width: 95%;
            padding: 2.5rem;
            background-color: #fff;
            border-radius: 1rem; /* Slightly larger rounded corners */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        .header-line {
            border: 0;
            height: 1px;
            background: #e2e8f0;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.35rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.875rem; /* Increased size */
            letter-spacing: 0.05em;
        }
        /* Specific Status Colors */
        .status-pending { background-color: #fcd34d; color: #78350f; } /* Amber */
        .status-approved { background-color: #a7f3d0; color: #065f46; } /* Emerald */
        .status-rejected { background-color: #fecaca; color: #991b1b; } /* Red */
        .document-link {
            color: #4f46e5;
            text-decoration: underline;
            cursor: pointer;
        }
        /* Responsive Grid for Details */
        @media (max-width: 640px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="main-class-dashboard-layout">

    <main class="content-box">
        <header>
            <h1 class="text-3xl font-extrabold text-gray-900">Loan Application Dashboard</h1>
            <h2 class="text-xl text-gray-600 mt-2">Check Your Current Status</h2>
            <hr class="header-line">
            <p class="text-sm text-red-500 font-medium hidden" id="errorMessage"></p>
        </header>

        <div id="statusContainer" class="space-y-8">
            <div id="loadingMessage" class="text-center p-6 bg-indigo-50 rounded-xl shadow-inner">
                <p class="text-indigo-600 font-semibold text-lg">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading status...
                </p>
            </div>
            
            <div id="noApplicationMessage" class="hidden text-center p-8 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
                <p class="text-lg text-gray-700 font-bold mb-3">No Active Application Found</p>
                <p class="text-gray-500">
                    Your application status is not yet available. Please ensure you have completed the 
                    <a href="agreement.html" class="text-indigo-600 hover:text-indigo-800 font-medium underline transition duration-150">Loan Agreement</a> and 
                    <a href="signup.html" class="text-indigo-600 hover:text-indigo-800 font-medium underline transition duration-150">Application Form</a> first.
                </p>
            </div>

            <div id="loanDetails" class="hidden">
                <!-- Status Header -->
                <div class="mb-6 p-4 border-l-4 border-indigo-500 bg-indigo-50 rounded-r-lg shadow-sm">
                    <h4 class="text-lg font-semibold text-indigo-700">Current Status:</h4>
                    <div id="detailStatus" class="mt-1 text-2xl font-extrabold">
                        <!-- Status badge inserted here -->
                    </div>
                </div>

                <h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Application Details</h3>

                <div class="detail-grid grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 p-4 rounded-lg">
                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">ID Number:</div>
                        <div id="detailID" class="text-gray-800 font-semibold"></div>
                    </div>
                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">Name:</div>
                        <div id="detailName" class="text-gray-800 font-semibold truncate"></div>
                    </div>

                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">Requested Amount:</div>
                        <div id="detailAmount" class="text-green-600 font-extrabold"></div>
                    </div>

                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">Repayment Period:</div>
                        <div id="detailRepayment" class="text-gray-800 font-semibold"></div>
                    </div>
                    
                    <div class="col-span-1">
                        <div class="font-medium text-gray-600">Interest Rate:</div>
                        <div id="detailInterest" class="text-red-500 font-semibold"></div>
                    </div>
                </div>

                <h4 class="text-xl font-semibold mt-8 mb-3 text-gray-800 border-b pb-2">Submitted Documents</h4>
                <div id="documentLinks" class="space-y-2 text-sm text-gray-700 p-4 bg-gray-50 rounded-lg">
                    <!-- Document confirmation text inserted here -->
                </div>
                
                <!-- Section for approved/rejected messages -->
                <div id="statusMessage" class="mt-6 p-4 rounded-lg font-medium hidden">
                    <!-- Dynamic message based on status -->
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-center">
            <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium transition duration-150">Go back to Home</a>
        </div>
    </main>

    <!-- Supabase and Dashboard Logic -->
    <script type="module">
        // Import Supabase Client
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        // Supabase configuration (as defined in previous steps)
        const SUPABASE_URL = 'https://kujvvupdqvtkncolhcul.supabase.co';
        const SUPABASE_ANON_KEY =
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1anZ2dXBkcXZ0a25jb2xoY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM0MzgsImV4cCI6MjA3OTM3OTQzOH0.VBnQywbTQwwWFLmjUAZggfIWC1_J5opHdFwyqMDD3QE';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /**
         * Fetches borrower status from Supabase based on ID number.
         * @param {string} idNumber 
         * @returns {Promise<Object | null>}
         */
        async function lookupBorrowerStatus(idNumber){
            if (!idNumber) return null;
            try {
                const { data, error } = await supabase.from('borrowers')
                    .select('id_number, full_name, status, requested_amount, interest_rate, repayment_period, document_id_url, document_address_url, document_bank_url')
                    .eq('id_number', idNumber).single();
                
                // PGRST116 means no rows found (ID not in database)
                if (error && error.code!=='PGRST116') { 
                    console.error("Supabase Error:", error); 
                    return null; 
                }
                return data || null;
            } catch(e){ 
                console.error("Lookup Exception:", e); 
                return null; 
            }
        }

        // Logic for the Dashboard Page
        document.addEventListener('DOMContentLoaded', async () => {
            const userId = localStorage.getItem('currentUserId');
            const loadingMessage = document.getElementById('loadingMessage');
            const noApplicationMessage = document.getElementById('noApplicationMessage');
            const loanDetails = document.getElementById('loanDetails');
            const statusMessageDiv = document.getElementById('statusMessage');

            if (!userId) {
                loadingMessage.classList.add('hidden');
                noApplicationMessage.classList.remove('hidden');
                return;
            }

            const statusData = await lookupBorrowerStatus(userId);
            loadingMessage.classList.add('hidden');

            if (!statusData) {
                noApplicationMessage.classList.remove('hidden');
                return;
            }

            // Destructure data
            const { 
                status, 
                full_name, 
                requested_amount, 
                repayment_period, 
                interest_rate, 
                document_id_url, 
                document_address_url, 
                document_bank_url 
            } = statusData;

            // --- 1. Display Core Details ---
            document.getElementById('detailName').textContent = full_name;
            document.getElementById('detailID').textContent = userId;
            document.getElementById('detailAmount').textContent = `R${requested_amount.toFixed(2)}`;
            document.getElementById('detailRepayment').textContent = `${repayment_period} days`;
            document.getElementById('detailInterest').textContent = `${(parseFloat(interest_rate) * 100).toFixed(2)}%`;
            
            // --- 2. Display Status Badge ---
            let statusClass = 'status-pending';
            let messageContent = '';
            let messageBg = '';

            if (status === 'approved') {
                statusClass = 'status-approved';
                messageBg = 'bg-green-100 border-green-500 text-green-800';
                messageContent = `Congratulations! Your loan of R${requested_amount.toFixed(2)} has been APPROVED. The funds will be transferred to your bank account within 24 hours.`;
            } else if (status === 'rejected') {
                statusClass = 'status-rejected';
                messageBg = 'bg-red-100 border-red-500 text-red-800';
                messageContent = `Your loan application has been REJECTED at this time. This decision is based on a review of the submitted documentation and eligibility criteria.`;
            } else {
                // Pending
                messageBg = 'bg-yellow-100 border-yellow-500 text-yellow-800';
                messageContent = `Your application is currently PENDING review by our finance team. We will update you with a final decision within 48 hours. Thank you for your patience.`;
            }
            
            document.getElementById('detailStatus').innerHTML = `
                <span class="status-badge ${statusClass}">${status}</span>
            `;

            // Display dynamic status message
            statusMessageDiv.className = `mt-6 p-4 rounded-lg font-medium border-l-4 ${messageBg}`;
            statusMessageDiv.innerHTML = `<p>${messageContent}</p>`;
            statusMessageDiv.classList.remove('hidden');


            // --- 3. Display Document Confirmation ---
            const checkIcon = '&#10003;'; // Check mark
            const crossIcon = '&#10007;'; // Cross mark

            const getDocStatus = (url, name) => {
                const icon = url ? checkIcon : crossIcon;
                const color = url ? 'text-green-600' : 'text-red-500';
                const text = url ? 'Upload Confirmed' : 'Missing or Error';
                return `<p class="flex justify-between">
                            <span class="font-bold">${name}:</span> 
                            <span class="${color}">${icon} ${text}</span>
                        </p>`;
            };

            document.getElementById('documentLinks').innerHTML = 
                getDocStatus(document_id_url, 'ID Document') +
                getDocStatus(document_address_url, 'Proof of Address') +
                getDocStatus(document_bank_url, 'Bank Statement');

            loanDetails.classList.remove('hidden');
        });

    </script>
</body>
</html>
