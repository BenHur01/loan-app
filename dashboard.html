<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Application Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body {
    font-family: 'Inter', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: #f0f4f8;
}
.content-box {
    max-width: 720px;
    width: 95%;
    padding: 2.5rem;
    background-color: #fff;
    border-radius: 1rem;
    box-shadow: 0 15px 40px rgba(0,0,0,.15);
}
.status-badge {
    padding: .35rem 1rem;
    border-radius: 9999px;
    font-weight: 800;
    text-transform: uppercase;
    font-size: .85rem;
}
.status-pending { background:#fde68a; color:#78350f }
.status-approved { background:#bbf7d0; color:#065f46 }
.status-denied { background:#fecaca; color:#991b1b }
</style>
</head>

<body>
<main class="content-box">

<header>
    <h1 class="text-3xl font-extrabold text-gray-900">Loan Application Dashboard</h1>
    <h2 class="text-xl text-gray-600 mt-2">Check Your Current Status</h2>
    <hr class="my-6">
</header>

<!-- WhatsApp -->
<div class="mb-6 p-5 bg-green-50 border-l-4 border-green-500 rounded-lg shadow">
    <h4 class="text-lg font-bold text-green-800 mb-2">ACTION REQUIRED</h4>
    <p class="text-gray-700 mb-3">
        Please take a screenshot of this dashboard and send it immediately to Sylvester on WhatsApp.
    </p>
    <a href="https://wa.me/27832004918"
       target="_blank"
       class="inline-flex items-center justify-center px-6 py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 transition">
       üì≤ Send Screenshot on WhatsApp
    </a>
</div>

<!-- Status -->
<div class="mb-6 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
    <h4 class="font-semibold text-indigo-700">Current Status:</h4>
    <div id="statusBadge" class="mt-2"></div>
</div>

<!-- Details -->
<h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Application Details</h3>

<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
<div>
    <p class="text-gray-600 font-medium">ID Number</p>
    <p id="detailID" class="font-semibold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Full Name</p>
    <p id="detailName" class="font-semibold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Requested Amount</p>
    <p id="detailRequested" class="text-green-600 font-extrabold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Amount to Repay (50%)</p>
    <p id="detailFinal" class="text-red-600 font-extrabold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Repayment Due Date</p>
    <p id="detailDueDate" class="font-semibold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Countdown</p>
    <p id="countdown" class="font-extrabold text-red-700"></p>
</div>
</div>

<!-- Payment -->
<div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
    <h4 class="font-bold text-gray-800 mb-1">Preferred Payment Type</h4>
    <p id="paymentType" class="font-semibold text-indigo-600"></p>
</div>

<!-- Footer -->
<div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
    <p class="text-gray-700 font-medium">
        ‚è≥ Our team will review your application and respond within <strong>24 hours</strong>.
    </p>
</div>

<div class="mt-8 text-center">
    <a href="index.html" class="text-indigo-600 font-medium hover:underline">Go back to Home</a>
</div>

</main>

<script>
const supabaseClient = supabase.createClient(
  "https://kujvvupdqvtkncolhcul.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1anZ2dXBkcXZ0a25jb2xoY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM0MzgsImV4cCI6MjA3OTM3OTQzOH0.VBnQywbTQwwWFLmjUAZggfIWC1_J5opHdFwyqMDD3QE"
);

const userId = localStorage.getItem("currentUserId");

const zar = new Intl.NumberFormat("en-ZA", {
  style: "currency",
  currency: "ZAR"
});

async function loadDashboard() {
  if (!userId) {
    console.log("‚ùå No userId in localStorage");
    return;
  }

  const { data, error } = await supabaseClient
    .from("borrowers")
    .select("*")
    .eq("id_number", userId)
    .single();

  if (error) {
    console.error("‚ùå Supabase error:", error.message);
    return;
  }

  console.log("‚úÖ Borrower data:", data);

  const dueDate = new Date(data.repayment_due_date);
  const repayAmount = data.requested_amount * 1.5;

  document.getElementById("detailID").textContent = data.id_number;
  document.getElementById("detailName").textContent = data.full_name;
  document.getElementById("detailRequested").textContent = zar.format(data.requested_amount);
  document.getElementById("detailFinal").textContent = zar.format(repayAmount);
  document.getElementById("detailDueDate").textContent =
    dueDate.toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"});

  document.getElementById("paymentType").textContent =
    data.preferred_payment_type || "Not selected";

  const status = (data.status || "pending").toLowerCase();
  document.getElementById("statusBadge").innerHTML =
    `<span class="status-badge status-${status}">${status}</span>`;

  const countdownEl = document.getElementById("countdown");
  setInterval(() => {
    const diff = dueDate - new Date();
    if (diff <= 0) countdownEl.textContent = "OVERDUE";
    else {
      const d = Math.floor(diff / 86400000);
      const h = Math.floor(diff / 3600000) % 24;
      countdownEl.textContent = `${d} days ${h} hours`;
    }
  }, 1000);
}

loadDashboard();
</script>
</body>
</html>

