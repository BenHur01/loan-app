<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Application Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>

<script id="supabase-config"
  data-url="https://kujvvupdqvtkncolhcul.supabase.co"
  data-anon-key="YOUR_ANON_KEY">
</script>

<style>
body {
    font-family: 'Inter', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: #f0f4f8;
}
.content-box {
    max-width: 720px;
    width: 95%;
    padding: 2.5rem;
    background-color: #fff;
    border-radius: 1rem;
    box-shadow: 0 15px 40px rgba(0,0,0,.15);
}
.status-badge {
    padding: .35rem 1rem;
    border-radius: 9999px;
    font-weight: 800;
    text-transform: uppercase;
    font-size: .85rem;
}
.status-pending { background:#fde68a; color:#78350f }
.status-approved { background:#bbf7d0; color:#065f46 }
.status-rejected { background:#fecaca; color:#991b1b }
</style>
</head>

<body>
<main class="content-box">

<header>
    <h1 class="text-3xl font-extrabold text-gray-900">Loan Application Dashboard</h1>
    <h2 class="text-xl text-gray-600 mt-2">Check Your Current Status</h2>
    <hr class="my-6">
</header>

<!-- WhatsApp Action Box -->
<div class="mb-6 p-5 bg-green-50 border-l-4 border-green-500 rounded-lg shadow">
    <h4 class="text-lg font-bold text-green-800 mb-2">ACTION REQUIRED</h4>
    <p class="text-gray-700 mb-3">
        Please take a screenshot of this dashboard and send it immediately to Sylvester on WhatsApp.
    </p>
    <a href="https://wa.me/27832004918"
       target="_blank"
       class="inline-flex items-center justify-center px-6 py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 transition">
       üì≤ Send Screenshot on WhatsApp
    </a>
</div>

<!-- Status -->
<div class="mb-6 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
    <h4 class="font-semibold text-indigo-700">Current Status:</h4>
    <div id="statusBadge" class="mt-2"></div>
</div>

<!-- Application Details -->
<h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Application Details</h3>

<div class="grid grid-cols-1 md:grid-cols-2 gap-5">

<div>
    <p class="text-gray-600 font-medium">ID Number</p>
    <p id="detailID" class="font-semibold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Full Name</p>
    <p id="detailName" class="font-semibold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Requested Amount</p>
    <p id="detailRequested" class="text-green-600 font-extrabold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Amount to Repay (50%)</p>
    <p id="detailFinal" class="text-red-600 font-extrabold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Repayment Due Date</p>
    <p id="detailDueDate" class="font-semibold"></p>
</div>

<div>
    <p class="text-gray-600 font-medium">Countdown</p>
    <p id="countdown" class="font-extrabold text-red-700"></p>
</div>

</div>

<!-- Preferred Payment Type Box -->
<div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
    <h4 class="font-bold text-gray-800 mb-1">Preferred Payment Type</h4>
    <p id="paymentType" class="font-semibold text-indigo-600"></p>
</div>

<!-- Footer Note -->
<div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
    <p class="text-gray-700 font-medium">
        ‚è≥ Our team will review your application and get back to you within <strong>24 hours</strong>.
    </p>
</div>

<div class="mt-8 text-center">
    <a href="index.html" class="text-indigo-600 font-medium hover:underline">Go back to Home</a>
</div>

</main>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const config = document.getElementById("supabase-config");
const supabase = createClient(config.dataset.url, config.dataset.anonKey);

const userId = localStorage.getItem("currentUserId");

const zar = new Intl.NumberFormat("en-ZA", {
  style: "currency",
  currency: "ZAR"
});

function monthEnd() {
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59);
}

async function loadDashboard() {
  if (!userId) return;

  const { data } = await supabase
    .from("borrowers")
    .select("*")
    .eq("id_number", userId)
    .single();

  if (!data) return;

  const repay = data.requested_amount * 1.5;
  const due = monthEnd();

  document.getElementById("detailID").textContent = data.id_number;
  document.getElementById("detailName").textContent = data.full_name;
  document.getElementById("detailRequested").textContent = zar.format(data.requested_amount);
  document.getElementById("detailFinal").textContent = zar.format(repay);
  document.getElementById("detailDueDate").textContent =
    due.toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"});

  document.getElementById("paymentType").textContent =
    data.preferred_payment_type || "Not selected";

  const badge = document.getElementById("statusBadge");
  const status = (data.status || "pending").toLowerCase();
  badge.innerHTML = `<span class="status-badge status-${status}">${status}</span>`;

  const cd = document.getElementById("countdown");
  setInterval(()=>{
    const diff = due - new Date();
    if (diff <= 0) cd.textContent = "OVERDUE";
    else {
      const d = Math.floor(diff/86400000);
      const h = Math.floor(diff/3600000)%24;
      cd.textContent = `${d}d ${h}h`;
    }
  },1000);
}

loadDashboard();
</script>

</body>
</html>
