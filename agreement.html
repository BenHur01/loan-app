<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Agreement</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles using the 'Inter' font family */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 800px;
            width: 95%;
            padding: 2.5rem;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .scroll-box {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background-color: #fafafa;
            margin-bottom: 1.5rem;
        }
        /* Custom utility for emphasizing dynamic data */
        .dynamic-data {
            font-weight: 700;
            color: #1e40af; /* Tailwind indigo-700 equivalent */
            background-color: #e0e7ff; /* Tailwind indigo-100 equivalent */
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    
    <main class="container">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Loan Agreement and Terms</h1>
            <p class="text-gray-500 mt-2">Please read carefully before proceeding.</p>
        </header>

        <!-- Loan Amount Input -->
        <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
            <label for="loanAmount" class="block text-lg font-medium text-indigo-700 mb-2">Enter Requested Loan Amount (R200 - R2000):</label>
            <input type="number" id="loanAmount" min="200" max="2000" step="50" placeholder="e.g., 500" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <!-- Display calculated repayment amount for quick reference -->
            <p class="mt-3 text-sm text-indigo-700">
                Total Repayment Due (Principal + 50% Interest): 
                <span id="calculatedRepayment" class="font-bold text-indigo-800">R0.00</span>
            </p>
        </div>

        <div class="scroll-box text-sm text-gray-700 leading-relaxed">
            <h2 class="text-lg font-semibold mb-3 text-gray-800">Terms and Conditions</h2>
            <p class="mb-4">1. Loan Contract: This agreement constitutes a legally binding contract between the Borrower (you) and the Lender (Sylvester). By agreeing to these terms, you confirm your intent and ability to repay the borrowed funds.</p>

            <p class="mb-4">2. Interest Rate: All loans issued through this platform carry a fixed interest rate of 50% (fifty percent) simple interest over the repayment period. This rate is non-negotiable.</p>

            <!-- DYNAMIC REPAYMENT CLAUSE -->
            <p class="mb-4">3. Repayment Due Date: The full repayment amount of 
                <span id="totalRepaymentAmount" class="dynamic-data">R0.00</span> 
                for all approved loans is due on 
                <span id="dueDateText" class="dynamic-data">Calculating Date...</span>
                (End of current month).
            </p>
            <!-- END DYNAMIC REPAYMENT CLAUSE -->

            <p class="mb-4">4. Default: Failure to repay the full amount (principal + interest) within the current month period will result in penalties and late fees as per South African financial regulations, and your account may be handed over to a collections agency. You are responsible for any legal fees incurred during the collection process.</p>

            <p class="mb-4">5. Data Privacy: We commit to protecting your personal information. Your uploaded documents (ID, Proof of Address, Bank Statement, and Live Selfie) will be stored securely and will only be used for the purpose of loan verification and fraud prevention.</p>

            <p class="mb-4">6. Verification: By proceeding, you consent to background checks and verification of the documents and personal details you provide in the subsequent application form.</p>
            
            <p class="mb-4">7. Eligibility: You must be a South African citizen or permanent resident, over the age of 18, and currently employed to be eligible for a loan.</p>

            <p class="mb-4">
                <strong class="text-indigo-600">8. Special Requests, Issues, and Repayment Difficulties:</strong> 
                The Borrower is required to adhere strictly to the agreed repayment schedule. Should the Borrower face any unforeseen issues, special requests regarding the loan terms, or difficulties making payment, they must contact the dedicated Loan Officer, Sylvester, immediately. 
                Communication for these matters must be initiated via WhatsApp at the number provided on the dashboard: <a href="https://wa.me/27832004918" target="_blank" class="text-green-600 font-bold underline">083 200 4918</a>. 
                It is understood that all such requests, including extensions or adjustments, are subject to review and final approval by the Lender. Failure to communicate payment issues *before* the due date may lead to default penalties and fees outlined elsewhere in this agreement.
            </p>
        </div>
        
        <form id="agreementForm" class="space-y-4">
            <!-- Message box for errors and success messages -->
            <div id="messageBox" class="p-3 text-sm rounded-lg hidden" role="alert"></div>

            <div class="flex items-start space-x-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                <input type="checkbox" id="termsCheck" required class="mt-1 w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <label for="termsCheck" class="font-medium text-gray-700 text-sm">I confirm that I have read and agree to all the Terms and Conditions above, including the 50% interest rate and 30-day repayment period.</label>
            </div>
            
            <button type="submit" id="proceedBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-lg" disabled>
                Agree & Proceed to Application Form
            </button>
        </form>

        <div class="mt-8 text-center">
            <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Go back to Home</a>
        </div>
    </main>

    <!-- CRITICAL FIX: ALL JS CODE IS NOW INLINE, USING FIREBASE/FIRESTORE -->
    <script type="module">
        // --- FIREBASE IMPORTS AND INITIALIZATION (MANDATORY) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // The fix is here: we explicitly import collection and getFirestore
        import { getFirestore, doc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Use the global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;

        // Function to display messages instead of alert()
        function showMessage(message, type = 'error') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'p-3 text-sm rounded-lg';
            messageBox.classList.remove('bg-red-100', 'text-red-800', 'border-red-400', 'bg-green-100', 'text-green-800', 'border-green-400', 'hidden');

            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-400');
            }
            messageBox.classList.remove('hidden');
        }

        // --- Utility Functions ---
        function isValidAmount() {
            const amount = parseFloat(document.getElementById('loanAmount').value);
            return !isNaN(amount) && amount >= 200 && amount <= 2000;
        }

        function areTermsChecked() {
            return document.getElementById('termsCheck').checked;
        }

        function getLastDayOfCurrentMonth() {
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const lastDay = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 0);
            return lastDay;
        }

        function formatDate(date) {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function calculateRepayment(principal) {
            const interestRate = 0.50;
            const totalRepayment = principal * (1 + interestRate);
            return totalRepayment;
        }

        function updateAgreementTextAndButton() {
            const loanAmountInput = document.getElementById('loanAmount');
            const amount = parseFloat(loanAmountInput.value);

            const totalRepaymentAmountEl = document.getElementById('totalRepaymentAmount');
            const calculatedRepaymentEl = document.getElementById('calculatedRepayment');
            const dueDateTextEl = document.getElementById('dueDateText');
            const proceedBtn = document.getElementById('proceedBtn');

            totalRepaymentAmountEl.textContent = 'R0.00';
            calculatedRepaymentEl.textContent = 'R0.00';
            proceedBtn.disabled = true;

            const validAmount = isValidAmount();
            const termsAgreed = areTermsChecked();

            if (!validAmount) {
                dueDateTextEl.textContent = 'Enter amount to calculate.';
                return;
            }

            const totalRepayment = calculateRepayment(amount);
            const dueDate = getLastDayOfCurrentMonth();
            const formattedDueDate = formatDate(dueDate);

            totalRepaymentAmountEl.textContent = `R${totalRepayment.toFixed(2)}`;
            calculatedRepaymentEl.textContent = `R${totalRepayment.toFixed(2)}`;
            dueDateTextEl.textContent = formattedDueDate;
            
            proceedBtn.disabled = !(validAmount && termsAgreed);
        }
        
        // --- Initialization and Auth ---
        // We define the module-scoped variables here and ensure they are assigned.
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                // Assign db and auth here, making them available in the module scope
                db = getFirestore(app);
                auth = getAuth(app);

                await setPersistence(auth, browserSessionPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be finalized
                return new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            userId = crypto.randomUUID(); 
                        }
                        isAuthReady = true;
                        unsubscribe();
                        resolve();
                    });
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                userId = crypto.randomUUID();
                isAuthReady = true;
            }
        }

        // --- Main Logic on Load ---
        window.addEventListener('load', async () => {
            // Wait for initialization and auth to complete
            await initializeAppAndAuth();
            
            const loanAmountInput = document.getElementById('loanAmount');
            const termsCheck = document.getElementById('termsCheck');
            
            updateAgreementTextAndButton();
            
            // Event listeners
            loanAmountInput.addEventListener('input', updateAgreementTextAndButton);
            termsCheck.addEventListener('change', updateAgreementTextAndButton);


            // Form submission logic
            document.getElementById('agreementForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                // CRITICAL CHECK: Ensure db is actually initialized before proceeding
                if (!db) {
                     console.error("Firestore database object (db) is undefined. Check initialization.");
                     showMessage("A connection error occurred. Please refresh the page and try again.", 'error');
                     return;
                }

                if (!isAuthReady || !userId) {
                    showMessage("Authentication is not ready. Please try again in a moment.", 'error');
                    return;
                }
                
                if (!isValidAmount() || !areTermsChecked()) {
                    showMessage("Please check the loan amount and ensure you have agreed to the terms.", 'error');
                    return;
                }

                const amount = parseFloat(loanAmountInput.value);
                const repaymentAmount = calculateRepayment(amount);
                const dueDate = getLastDayOfCurrentMonth();
                
                const loanData = {
                    requestedAmount: amount,
                    totalRepaymentDue: repaymentAmount,
                    interestRate: 0.50,
                    repaymentDueDate: dueDate.toISOString().split('T')[0], // YYYY-MM-DD
                    dateRequested: new Date().toISOString(),
                    status: 'Pending',
                    userId: userId
                };

                try {
                    // Path: /artifacts/{appId}/users/{userId}/loan_applications/{documentId}
                    // The doc() function requires the Firestore instance (db) as the first argument, 
                    // followed by the collection path segments.
                    const loanDocRef = doc(
                        db, // <--- This MUST be the initialized Firestore instance
                        `artifacts/${appId}/users/${userId}/loan_applications`, 
                        `loan_${Date.now()}`
                    );
                    
                    // Save loan details to Firestore
                    await setDoc(loanDocRef, loanData);
                    showMessage("Loan details saved. Redirecting...", 'success');
                    
                    // Redirect to the application form
                    setTimeout(() => {
                        window.location.href = 'signup.html';
                    }, 500);

                } catch (e) {
                    // Log the full error and display a detailed message
                    console.error("Error saving document to Firestore: ", e);
                    // This often happens if Firestore permissions are wrong (e.g., if you are running outside Canvas)
                    showMessage(`Failed to save loan details. Error: ${e.message}`, 'error');
                }
            });
        });
    </script>
</body>
</html>
