<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Agreement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Removed external stylesheet link as all content must be in a single file -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 800px;
            width: 95%;
            padding: 2.5rem;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .scroll-box {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background-color: #fafafa;
            margin-bottom: 1.5rem;
        }
        /* Custom style for terms paragraphs to match the original structure */
        .scroll-box p {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    
    <main class="container">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Loan Agreement and Terms</h1>
            <p class="text-gray-500 mt-2">Please read carefully before proceeding.</p>
        </header>

        <!-- Loan Amount Input -->
        <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
            <label for="loanAmount" class="block text-lg font-medium text-indigo-700 mb-2">Enter Requested Loan Amount (R200 - R2000):</label>
            <input type="number" id="loanAmount" min="200" max="2000" step="50" placeholder="e.g., 500" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" value="500">
        </div>

        <!-- TERMS AND CONDITIONS (RESTORED TO ORIGINAL 8 POINTS) -->
        <div class="scroll-box text-sm text-gray-700 leading-relaxed">
            <h2 class="text-lg font-semibold mb-3 text-gray-800">Terms and Conditions</h2>
            <p>1. Loan Contract: This agreement constitutes a legally binding contract between the Borrower (you) and the Lender (Sylvester). By agreeing to these terms, you confirm your intent and ability to repay the borrowed funds.</p>

            <p>2. Interest Rate: All loans issued through this platform carry a fixed interest rate of 50% (fifty percent) simple interest over the repayment period. This rate is non-negotiable.</p>

            <p>3. Repayment Period: The standard repayment period for all approved loans is thirty (30) calendar days from the date the funds are disbursed to your nominated bank account.</p>

            <p>4. Default: Failure to repay the full amount (principal + interest) within the 30-day period will result in penalties and late fees as per South African financial regulations, and your account may be handed over to a collections agency. You are responsible for any legal fees incurred during the collection process.</p>

            <p>5. Data Privacy: We commit to protecting your personal information. Your uploaded documents (ID, Proof of Address, Bank Statement, and Live Selfie) will be stored securely using and will only be used for the purpose of loan verification and fraud prevention.</p>

            <p>6. Verification: By proceeding, you consent to background checks and verification of the documents and personal details you provide in the subsequent application form.</p>
            
            <p class="mb-4">
                <strong class="text-indigo-600">7. Eligibility:</strong> You must be a South African citizen or permanent resident, over the age of 18, and currently employed to be eligible for a loan.
            </p>

            <p>
                <strong class="text-indigo-600">8. Special Requests, Issues, and Repayment Difficulties:</strong> 
                The Borrower is required to adhere strictly to the agreed repayment schedule. Should the Borrower face any unforeseen issues, special requests regarding the loan terms, or difficulties making payment, they must contact the dedicated Loan Officer, Sylvester, immediately. 
                Communication for these matters must be initiated via WhatsApp at the number provided on the dashboard: <a href="https://wa.me/27832004918" target="_blank" class="text-green-600 font-bold underline">083 200 4918</a>. 
                It is understood that all such requests, including extensions or adjustments, are subject to review and final approval by the Lender. Failure to communicate payment issues *before* the due date may lead to default penalties and fees outlined elsewhere in this agreement.
            </p>
        </div>
        
        <form id="agreementForm" class="space-y-4">
            <div class="flex items-start space-x-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                <input type="checkbox" id="termsCheck" required class="mt-1 w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <label for="termsCheck" class="font-medium text-gray-700 text-sm">I confirm that I have read and agree to all the Terms and Conditions above, including the 50% interest rate and 30-day repayment period.</label>
            </div>
            
            <button type="submit" id="proceedBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-lg">
                Agree & Proceed to Application Form
            </button>
            <p id="errorMsg" class="text-red-500 text-center mt-3 hidden"></p>
        </form>

        <div class="mt-8 text-center">
            <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Go back to Home</a>
        </div>
    </main>

    <!-- CRITICAL FIX: ALL JS CODE IS NOW INLINE and uses Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }

        async function initializeAuth() {
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }

        // Listen for authentication state changes and set userId
        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            if (user) {
                userId = user.uid;
                console.log("Authenticated with UID:", userId);
            } else {
                console.log("User signed out or anonymous.");
            }
        });

        // Function to calculate the month-end due date (as in the original dashboard logic)
        function calculateDueDate() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); 

            // If it's late in the month (e.g., past the 25th), push the due date to the next month's end.
            if (now.getDate() > 25) {
                month += 1; 
                if (month > 11) { 
                    month = 0; 
                    year += 1;
                }
            }

            // Date 0 of the next month is the last day of the current month
            const dueDate = new Date(year, month + 1, 0); 
            
            return dueDate.toISOString().split('T')[0];
        }


        // --- CORE FIX: Form Submission and Data Persistence ---
        const agreementForm = document.getElementById('agreementForm');
        const loanAmountInput = document.getElementById('loanAmount');
        const termsChecked = document.getElementById('termsCheck');
        const proceedBtn = document.getElementById('proceedBtn');
        const errorMsg = document.getElementById('errorMsg');

        agreementForm.addEventListener('submit', async function(e) {
            // CRITICAL FIX: Prevent the default form submission/page reload, which caused the loop/hang
            e.preventDefault(); 
            errorMsg.classList.add('hidden');

            const amount = parseFloat(loanAmountInput.value);

            if (isNaN(amount) || amount < 200 || amount > 2000) {
                errorMsg.textContent = "Please enter a valid loan amount between R200 and R2000.";
                errorMsg.classList.remove('hidden');
                return;
            }

            if (!termsChecked.checked) {
                errorMsg.textContent = "You must agree to the terms and conditions to proceed.";
                errorMsg.classList.remove('hidden');
                return;
            }

            if (!isAuthReady || !userId) {
                errorMsg.textContent = "Application is still authenticating. Please wait a moment and try again.";
                errorMsg.classList.remove('hidden');
                if (!isAuthReady) initializeAuth();
                return;
            }

            // Disable button and show loading state
            proceedBtn.disabled = true;
            proceedBtn.textContent = 'Processing...';

            const dueDate = calculateDueDate();
            const loanData = {
                requestedAmount: amount.toFixed(2),
                dueDate: dueDate, 
                agreedAt: new Date().toISOString(),
                userId: userId,
                // Initialize default status for the dashboard
                status: 'pending' 
            };

            try {
                // Save loan agreement details to Firestore
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/loan_data/agreement_details`);
                await setDoc(docRef, loanData);

                // SUCCESS: Redirect to the application form
                window.location.href = 'signup.html';

            } catch (error) {
                console.error("Error saving loan agreement:", error);
                errorMsg.textContent = `Error: Could not save data. ${error.message}. Please refresh and try again.`;
                errorMsg.classList.remove('hidden');
                
                // Re-enable button on error
                proceedBtn.disabled = false;
                proceedBtn.textContent = 'Agree & Proceed to Application Form';
            }
        });

        // Kick off the initial authentication process
        if (typeof auth !== 'undefined') {
             initializeAuth();
        }
    </script>
</body>
</html>
