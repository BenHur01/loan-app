<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Agreement</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to maintain the original look and feel */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 800px;
            width: 95%;
            padding: 2.5rem;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .scroll-box {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background-color: #fafafa;
            margin-bottom: 1.5rem;
        }
        .scroll-box p {
            margin-bottom: 1rem;
        }
        /* Style for mobile responsiveness */
        @media (max-width: 640px) {
            .container {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    
    <main class="container">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Loan Agreement and Terms</h1>
            <p class="text-gray-500 mt-2">Please read carefully before proceeding.</p>
        </header>

        <!-- Loan Amount Input -->
        <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
            <label for="loanAmount" class="block text-lg font-medium text-indigo-700 mb-2">Enter Requested Loan Amount (R200 - R2000):</label>
            <input type="number" id="loanAmount" min="200" max="2000" step="50" placeholder="e.g., 500" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <div class="scroll-box text-sm text-gray-700 leading-relaxed">
            <h2 class="text-lg font-semibold mb-3 text-gray-800">Terms and Conditions</h2>
            <p class="mb-4">1. Loan Contract: This agreement constitutes a legally binding contract between the Borrower (you) and the Lender (Sylvester). By agreeing to these terms, you confirm your intent and ability to repay the borrowed funds.</p>

            <p class="mb-4">2. Interest Rate: All loans issued through this platform carry a fixed interest rate of 50% (fifty percent) simple interest over the repayment period. This rate is non-negotiable.</p>

            <!-- UPDATED CLAUSE 3 -->
            <p class="mb-4">
                <strong class="text-indigo-600">3. Repayment Due Date:</strong> 
                The full repayment (Principal + Interest) for all approved loans is due on the **last calendar day of the month** in which the loan funds are disbursed to your nominated bank account.
            </p>

            <!-- UPDATED CLAUSE 4 -->
            <p class="mb-4">
                <strong class="text-indigo-600">4. Default:</strong> 
                Failure to repay the full amount (principal + interest) by the agreed **month-end due date** will result in penalties and late fees as per South African financial regulations, and your account may be handed over to a collections agency. You are responsible for any legal fees incurred during the collection process.
            </p>

            <p class="mb-4">5. Data Privacy: We commit to protecting your personal information. Your uploaded documents (ID, Proof of Address, Bank Statement, and Live Selfie) will be stored securely using and will only be used for the purpose of loan verification and fraud prevention.</p>

            <p class="mb-4">6. Verification: By proceeding, you consent to background checks and verification of the documents and personal details you provide in the subsequent application form.</p>
            
            <p class="mb-4">7. Eligibility: You must be a South African citizen or permanent resident, over the age of 18, and currently employed to be eligible for a loan.</p>

            <p class="mb-4">
                <strong class="text-indigo-600">8. Special Requests, Issues, and Repayment Difficulties:</strong> 
                The Borrower is required to adhere strictly to the agreed repayment schedule. Should the Borrower face any unforeseen issues, special requests regarding the loan terms, or difficulties making payment, they must contact the dedicated Loan Officer, Sylvester, immediately. 
                Communication for these matters must be initiated via WhatsApp at the number provided on the dashboard: <a href="https://wa.me/27832004918" target="_blank" class="text-green-600 font-bold underline">083 200 4918</a>. 
                It is understood that all such requests, including extensions or adjustments, are subject to review and final approval by the Lender. Failure to communicate payment issues *before* the due date may lead to default penalties and fees outlined elsewhere in this agreement.
            </p>
        </div>
        
        <form id="agreementForm" class="space-y-4">
            <div class="flex items-start space-x-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                <input type="checkbox" id="termsCheck" required class="mt-1 w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <!-- UPDATED CHECKBOX LABEL -->
                <label for="termsCheck" class="font-medium text-gray-700 text-sm">I confirm that I have read and agree to all the Terms and Conditions above, including the 50% interest rate and month-end due date.</label>
            </div>
            
            <button type="submit" id="proceedBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-lg">
                Agree & Proceed to Application Form
            </button>
        </form>

        <div class="mt-8 text-center">
            <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Go back to Home</a>
        </div>
    </main>

    <!-- Message Modal/Box (Replaces alert()) -->
    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0" id="messageBox">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-900 mb-3"></h3>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <button id="closeModalBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg">
                Close
            </button>
        </div>
    </div>

    <!-- CRITICAL FIX: ALL JS CODE IS NOW INLINE, FIREBASE USED FOR STORAGE -->
   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE INITIALIZATION & CONFIGURATION ---
    // Safely parse the global config variables
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    let firebaseConfig;

    try {
        firebaseConfig = JSON.parse(configString);
    } catch (e) {
        console.error("Error parsing Firebase config:", e);
        firebaseConfig = {};
    }

    let db, auth;
    let userId = null;
    let isAuthReady = false;
    let initialAuthCheckDone = false;
    let docPath = null;
    let appInitialized = false;

    // *** CRITICAL FIX: Only initialize if the config looks valid ***
    if (firebaseConfig && firebaseConfig.projectId) {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            appInitialized = true;
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }
    } else {
        console.error("Firebase Initialization Skipped: Configuration (projectId) not provided.");
    }


    // --- CORE LOGIC TO CHECK FOR EXISTING AGREEMENT (The Loop Guard) ---
    async function checkExistingAgreement() {
        if (!userId || !docPath || !appInitialized) return;

        const agreementRef = doc(db, docPath);
        try {
            const docSnap = await getDoc(agreementRef);
            
            // Check both Firestore status and local storage
            const isAgreementSigned = docSnap.exists() && docSnap.data().applicationStatus === 'agreement_signed';
            const isAmountStored = localStorage.getItem('requestedLoanAmount');
            
            if (isAgreementSigned && isAmountStored) {
                console.log("Existing agreement found. Redirecting to signup page.");
                window.location.href = 'signup.html';
            } else {
                console.log("No existing agreement or agreement incomplete. User can proceed with form.");
            }
        } catch (e) {
            console.error("Error checking existing agreement:", e);
        }
    }

    // --- AUTHENTICATION & SETUP ---
    async function initializeAuth() {
        if (!appInitialized) {
            showMessage('Error', 'Application setup failed. Firebase configuration is missing.');
            return;
        }
        
        try {
             // Use anonymous sign-in if no custom token logic is needed
            await signInAnonymously(auth); 
            console.log("Signed in anonymously.");
        } catch (error) {
            console.error("Firebase Auth Error:", error);
            showMessage('Error', 'Authentication failed. Please check your network connection.');
        }
    }

    // *** CRITICAL FIX: Only call onAuthStateChanged if 'auth' is defined ***
    if (auth) {
        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            if (user) {
                userId = user.uid;
                docPath = `artifacts/${appId}/users/${userId}/loan_data/agreement_details`;
                console.log("Authenticated with UID:", userId);
            } else {
                console.log("User signed out or anonymous.");
            }

            if (isAuthReady && !initialAuthCheckDone && userId) {
                initialAuthCheckDone = true;
                checkExistingAgreement();
            }
        });
    }


    // --- MESSAGE MODAL LOGIC (Your custom alert functions) ---
    const modal = document.getElementById('messageModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const messageBox = document.getElementById('messageBox');

    function showMessage(title, message) {
        if (!modal) { // Fallback for missing modal HTML
            alert(`${title}: ${message}`);
            return;
        }
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            messageBox.classList.remove('scale-95', 'opacity-0');
            messageBox.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function hideMessage() {
        if (!modal) return;
        messageBox.classList.remove('scale-100', 'opacity-100');
        messageBox.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }, 300);
    }

    if (closeModalBtn) closeModalBtn.addEventListener('click', hideMessage);
    if (modal) modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideMessage();
        }
    });

    // --- HELPER FUNCTION FOR MONTH-END DATE ---
    function getMonthEndDueDate() {
        const today = new Date();
        const nextMonth = today.getMonth() + 1;
        const year = today.getFullYear();
        return new Date(year, nextMonth, 0); 
    }

    // --- FORM SUBMISSION LOGIC ---
    const agreementForm = document.getElementById('agreementForm');
    const proceedBtn = document.getElementById('proceedBtn');

    if (agreementForm) agreementForm.addEventListener('submit', handleFormSubmit);

    async function handleFormSubmit(event) {
        event.preventDefault();

        const loanAmountInput = document.getElementById('loanAmount');
        const amount = parseFloat(loanAmountInput.value);
        const termsChecked = document.getElementById('termsCheck').checked;

        // Basic validation
        if (isNaN(amount) || amount < 200 || amount > 2000) {
            showMessage("Validation Error", "Please enter a valid loan amount between R200 and R2000.");
            loanAmountInput.focus();
            return;
        }

        if (!termsChecked) {
            showMessage("Validation Error", "You must agree to the terms and conditions to proceed.");
            return;
        }
        
        // Critical check for Firebase initialization
        if (!appInitialized) {
            showMessage('Error', 'Application not initialized. Check Firebase setup.');
            return;
        }

        // Critical check for Auth state
        if (!isAuthReady || !userId) {
            showMessage('Loading', 'Authentication is still loading. Please wait a moment and try again.');
            await initializeAuth(); 
            // If initializeAuth fails, userId is still null, and we'll check it again on next click.
            if (!userId) return; // Stop processing if still not authenticated
        }

        // Disable button and show loading state
        if (proceedBtn) {
            proceedBtn.disabled = true;
            proceedBtn.textContent = 'Saving & Proceeding...';
        }

        try {
            const dueDate = getMonthEndDueDate();
            const dueDateISO = dueDate.toISOString().split('T')[0];
            const docRef = doc(db, docPath);

            // 1. Save to Firestore
            await setDoc(docRef, {
                requestedAmount: amount.toFixed(2),
                agreedToTerms: true,
                agreementDate: new Date().toISOString(),
                dueDate: dueDateISO, 
                applicationStatus: 'agreement_signed', 
                userId: userId, 
            });

            console.log("Loan agreement details saved to Firestore successfully:", docPath);

            // 2. Save to Local Storage (The initial loop fix)
            localStorage.setItem('requestedLoanAmount', amount.toFixed(2));

            // 3. Redirect to the application form
            window.location.href = 'signup.html';

        } catch (e) {
            showMessage('Error', 'Failed to save agreement. Please check your connection and ensure your Firebase/Firestore rules allow anonymous writes.');
            console.error("Error saving document to Firestore: ", e);
            
            // Re-enable button on error
            if (proceedBtn) {
                proceedBtn.disabled = false;
                proceedBtn.textContent = 'Agree & Proceed to Application Form';
            }
        }
    }
    
    // CRITICAL FIX: Start the sign-in process immediately on page load
    initializeAuth();
    
    </script>
</body>
</html>

