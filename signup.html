<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Application Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
Â  Â  body {
Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  background-color: #f7f9fb;
Â  Â  }
Â  Â  .container {
Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  width: 95%;
Â  Â  Â  Â  padding: 2.5rem;
Â  Â  Â  Â  margin-top: 2rem;Â 
Â  Â  Â  Â  margin-bottom: 4rem;Â 
Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
Â  Â  }
Â  Â  .form-group { margin-bottom: 1.25rem; }
Â  Â  label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #1f2937; text-align: left; }
Â  Â  .file-label-text { display: flex; justify-content: space-between; align-items: center; width: 100%; }
Â  Â  input[type="text"], input[type="number"], input[type="tel"], input[type="file"], select, textarea {
Â  Â  Â  Â  width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: border-color 0.15s, box-shadow 0.15s; resize: vertical;
Â  Â  }
Â  Â  input:focus, select:focus, textarea:focus { border-color: #4f46e5; outline: 0; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
Â  Â  .custom-modal {
Â  Â  Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
Â  Â  Â  Â  display: flex; justify-content: center; align-items: center; z-index: 1001; transition: opacity 0.3s;
Â  Â  }
Â  Â  .custom-modal-content {
Â  Â  Â  Â  background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;
Â  Â  Â  Â  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  .loading-overlay {
Â  Â  Â  Â  position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9);
Â  Â  Â  Â  display: flex; justify-content: center; align-items: center; z-index: 100; flex-direction: column; text-align: center;
Â  Â  }
Â  Â  .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite; margin-bottom:1rem; }
Â  Â  @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
Â  Â  .payment-section-header { padding:0.75rem 0; margin-top:1.5rem; margin-bottom:0.5rem; font-size:1.125rem; font-weight:600; color:#1f2937; }
</style>
</head>
<body>

<div id="custom-alert-modal" class="custom-modal hidden">
Â  Â  <div class="custom-modal-content">
Â  Â  Â  Â  <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Alert</h3>
Â  Â  Â  Â  <div id="modal-message-container" class="text-gray-600 mb-6"><p id="modal-message"></p></div>
Â  Â  Â  Â  <div class="flex space-x-3 mt-4">
Â  Â  Â  Â  Â  Â  <button id="modal-cancel-button" class="w-1/2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg focus:outline-none hidden">Cancel</button>
Â  Â  Â  Â  Â  Â  <button id="modal-ok-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none">OK</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="loadingOverlay" class="loading-overlay hidden">
Â  Â  <div class="loader"></div>
Â  Â  <p id="loading-message" class="text-lg font-semibold text-indigo-700">Submitting your application and uploading documents...</p>
Â  Â  <p class="text-sm text-gray-600 mt-2">This may take a moment. Please do not close the window.</p>
</div>

<main class="container">
Â  Â  <header class="text-center mb-8">
Â  Â  Â  Â  <h1 id="formHeader" class="text-3xl font-bold text-gray-900">Loan Application Form</h1>
Â  Â  Â  Â  <p class="text-gray-500 mt-2">Personal, Address, Employment, and Document Uploads</p>
Â  Â  Â  Â  <div id="editModeAlert" class="mt-4 p-3 bg-red-100 border-l-4 border-red-500 text-red-700 font-medium hidden">
Â  Â  Â  Â  Â  Â  You are in **EDIT MODE**. Please correct your details and re-submit the form. Documents do not need to be re-uploaded.
Â  Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <form id="loanApplicationForm" class="space-y-6">

Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">1. Personal Details</legend>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="fullName">Full Name</label><input type="text" id="fullName" required placeholder="e.g., Jane Doe"></div>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="idNumber">South African ID Number</label><input type="text" id="idNumber" required pattern="\d{13}" title="Must be a 13-digit ID number" placeholder="e.g., 9001015000087"></div>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="contactNumber">Contact Number</label><input type="tel" id="contactNumber" required pattern="\d{10}" title="Must be a 10-digit phone number" placeholder="e.g., 0712345678"></div>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">2. Residential Address</legend>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="residentialAddress">Physical Address (Must match Proof of Residence)</label><textarea id="residentialAddress" rows="3" required placeholder="Street Address, Suburb, City, Postal Code"></textarea></div>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">3. Employment Details <span class="text-gray-500 text-sm">(Optional)</span></legend>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="employerName">Employer Name</label><input type="text" id="employerName" placeholder="e.g., ABC Pty Ltd"></div>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="employeeAddress">Employee Address</label><textarea id="employeeAddress" rows="2" placeholder="e.g., 123 Main Street, Sandton"></textarea></div>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">4. Payment Preference</legend>
Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-4">Please fill out only one of the payment sections below.</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="bankAccountFields">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="payment-section-header text-gray-800">ğŸ¦ Bank Account Transfer</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="bankName">Bank Name</label><input type="text" id="bankName" placeholder="e.g., FNB, Capitec, etc."></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="bankAccountNumber">Bank Account Number</label><input type="text" id="bankAccountNumber" placeholder="Account Number"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="linkedPhone">Phone Number Linked to Bank Account</label><input type="tel" id="linkedPhone" placeholder="10-digit phone number"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="my-6 border-t border-gray-300"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="cardlessServiceFields">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="payment-section-header text-gray-800">ğŸ“² Cardless Services</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="cardlessBank">Bank Name to receive Cardless Funds</label><input type="text" id="cardlessBank" placeholder="e.g., FNB, Capitec, etc."></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="cardlessPhone">Phone Number for Cardless Service</label><input type="tel" id="cardlessPhone" placeholder="10-digit phone number"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="cardlessId">Your ID Number (for Security)</label><input type="text" id="cardlessId" placeholder="Your 13-digit ID"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4 p-3 border border-yellow-400 bg-yellow-50 rounded-lg text-sm text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-yellow-800">Note:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>We will use this phone number to send the Cardless Cash PIN if your application is approved.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-6 p-4 border border-blue-400 bg-blue-50 rounded-lg text-sm text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold mb-2 text-blue-800">For Loan Repayment/Settlement (EFT) Reference:</p>
Â  Â  Â  Â  Â  Â  Â  Â  <ul class="list-disc list-inside space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Account Name: Savings Account</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Bank: Capitec</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Account Number: 1213614048</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Branch Code: 470010</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>REFERENCE: Your Name</li>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  Â  Â  <fieldset id="documentSection" class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">5. Required Documents</legend>
Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-4">Upload clear copies (PDF/JPG).</p>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="idDocument"><span class="file-label-text">Copy of ID Document <span class="text-red-500 font-bold">(Compulsory)</span></span></label><input type="file" id="idDocument" accept=".pdf,.jpg,.jpeg" required></div>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="bankStatement"><span class="file-label-text">Latest Bank Statement (Optional)</span></label><input type="file" id="bankStatement" accept=".pdf,.jpg,.jpeg"></div>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="proofOfAddress"><span class="file-label-text">Proof of Residence <span class="text-red-500 font-bold">(Compulsory)</span></span></label><input type="file" id="proofOfAddress" accept=".pdf,.jpg,.jpeg" required></div>
Â  Â  Â  Â  Â  Â  <div class="form-group"><label for="selfieDocument"><span class="file-label-text">Live Selfie <span class="text-red-500 font-bold">(Compulsory)</span></span></label><input type="file" id="selfieDocument" accept="image/*" required capture="user"></div>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm bg-indigo-50">
Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-700 px-2">6. Final Confirmation</legend>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-start cursor-pointer p-3 border border-indigo-200 bg-white rounded-lg shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="confirmationTick" required class="mt-1 mr-3 h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-gray-800 font-medium">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  I confirm all details are true and complete. I understand that any false statement may lead to rejection and legal action.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="digitalSignature" class="block text-base font-bold text-gray-900 mb-2">Type "YES" to digitally sign</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="digitalSignature" required placeholder="Type YES">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  <button type="submit" id="submitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-lg">Submit Application</button>
Â  Â  </form>

Â  Â  <div class="mt-8 text-center"><a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Cancel and Go to Home</a></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
Â  Â  // Define your constants
Â  Â  const SUPABASE_URL = 'https://kujvvupdqvtkncolhcul.supabase.co';
Â  Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1anZ2dXBkcXZ0a25jb2xoY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM0MzgsImV4cCI6MjA3OTM3OTQzOH0.VBnQywbTQwwWFLmjUAZggfIWC1_J5opHdFwyqMDD3QE';

Â  Â  // Create the client using the global variable 'supabase'
Â  Â  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
Â  Â  
Â  Â  // Global state variable for edit mode
Â  Â  let isEditMode = false;

Â  Â  // Utility functions (rest of your original code)
Â  Â  function showLoading(msg){ document.getElementById('loading-message').textContent=msg; document.getElementById('loadingOverlay').classList.remove('hidden'); document.body.style.overflow='hidden'; }
Â  Â  function hideLoading(){ document.getElementById('loadingOverlay').classList.add('hidden'); document.body.style.overflow='auto'; }
Â  Â  function customAlert(title,msg){Â 
Â  Â  Â  Â  const modal=document.getElementById('custom-alert-modal');
Â  Â  Â  Â  document.getElementById('modal-title').textContent=title;
Â  Â  Â  Â  document.getElementById('modal-message-container').innerHTML=`<p>${msg}</p>`;
Â  Â  Â  Â  document.getElementById('modal-cancel-button').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('modal-ok-button').classList.add('w-full');
Â  Â  Â  Â  modal.classList.remove('hidden');
Â  Â  Â  Â  return new Promise(res=>{
Â  Â  Â  Â  Â  Â  const ok=document.getElementById('modal-ok-button');
Â  Â  Â  Â  Â  Â  const handler=()=>{ modal.classList.add('hidden'); ok.removeEventListener('click',handler); res(); };
Â  Â  Â  Â  Â  Â  ok.addEventListener('click',handler);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function validateSAID(id){ return /^\d{13}$/.test(id); }
Â  Â  function isSectionFilled(inputs){ return Array.from(inputs).every(i=>i.value.trim()!==''); }

Â  Â  // Updated uploadFile function for Edit Mode: Only upload if a new file is selected
Â  Â  async function uploadFile(file, bucket, path, isRequired = true, isEdit = false) {
Â  Â  Â  Â  // In edit mode, if no file is selected, return null and skip upload.
Â  Â  Â  Â  if (isEdit && !file) {
Â  Â  Â  Â  Â  Â  return null; 
Â  Â  Â  Â  }
Â  Â  Â  Â  // In initial mode, if file is required and missing, throw error
Â  Â  Â  Â  if (isRequired && !file) {
Â  Â  Â  Â  Â  Â  throw new Error("Required file missing: " + path.split('/')[1]); 
Â  Â  Â  Â  }

Â  Â  Â  Â  const { data, error } = await supabaseClient.storage.from(bucket).upload(path, file, { upsert: true }); // Using upsert:true for overwriting
Â  Â  Â  Â  if (error) throw new Error(error.message);
Â  Â  Â  Â  const { data: publicUrlData } = supabaseClient.storage.from(bucket).getPublicUrl(data.path);
Â  Â  Â  Â  return publicUrlData.publicUrl;
Â  Â  }

Â  Â  
Â  Â  // --- NEW: Pre-fill/Edit Mode Logic ---

Â  Â  function initForm() {
Â  Â  Â  Â  const prefillDataRaw = sessionStorage.getItem('prefillData');
Â  Â  Â  Â  
Â  Â  Â  Â  if (prefillDataRaw) {
Â  Â  Â  Â  Â  Â  isEditMode = true;
Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('prefillData'); // Clear session storage after loading

Â  Â  Â  Â  Â  Â  const borrower = JSON.parse(prefillDataRaw);
Â  Â  Â  Â  Â  Â  const paymentDetails = JSON.parse(borrower.payment_details_json || '{}');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 1. Update UI for Edit Mode
Â  Â  Â  Â  Â  Â  document.getElementById('formHeader').textContent = 'Edit Loan Application Details';
Â  Â  Â  Â  Â  Â  document.getElementById('editModeAlert').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('submitButton').textContent = 'Update Application Details';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Hide and remove 'required' attribute from file inputs in edit mode
Â  Â  Â  Â  Â  Â  const docSection = document.getElementById('documentSection');
Â  Â  Â  Â  Â  Â  docSection.style.opacity = 0.5; // Visual hint that documents are optional
Â  Â  Â  Â  Â  Â  docSection.querySelector('legend').textContent = '5. Required Documents (Optional to Change)';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  docSection.querySelectorAll('input[type="file"]').forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  input.removeAttribute('required');
Â  Â  Â  Â  Â  Â  Â  Â  // Add a visual hint next to the file label text if the file is already uploaded
Â  Â  Â  Â  Â  Â  Â  Â  const fileKey = input.id.replace('Document', '_document_url');
Â  Â  Â  Â  Â  Â  Â  Â  if (borrower[fileKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let label = input.closest('.form-group').querySelector('.file-label-text');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (label) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.innerHTML += '<span class="text-green-600 font-bold ml-2">(Uploaded)</span>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });


Â  Â  Â  Â  Â  Â  // 2. Pre-fill Application Data
Â  Â  Â  Â  Â  Â  document.getElementById('fullName').value = borrower.full_name || '';
Â  Â  Â  Â  Â  Â  document.getElementById('idNumber').value = borrower.id_number || '';
Â  Â  Â  Â  Â  Â  // Disable ID number in edit mode to prevent changing the database key
Â  Â  Â  Â  Â  Â  document.getElementById('idNumber').disabled = true; 
Â  Â  Â  Â  Â  Â  document.getElementById('contactNumber').value = borrower.contact_number || '';
Â  Â  Â  Â  Â  Â  document.getElementById('residentialAddress').value = borrower.residential_address || '';
Â  Â  Â  Â  Â  Â  document.getElementById('employerName').value = borrower.employer_name || '';
Â  Â  Â  Â  Â  Â  document.getElementById('employeeAddress').value = borrower.employee_address || '';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 3. Pre-fill Payment Details (CORRECTED KEYS used here)
Â  Â  Â  Â  Â  Â  if (borrower.preferred_payment_type === 'Bank Account') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('bankName').value = paymentDetails.bank_name || '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('bankAccountNumber').value = paymentDetails.account_number || '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('linkedPhone').value = paymentDetails.linked_phone || '';
Â  Â  Â  Â  Â  Â  Â  Â  // Clear cardless fields
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('#cardlessServiceFields input').forEach(input => input.value = '');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  } else if (borrower.preferred_payment_type === 'Cardless Services') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('cardlessBank').value = paymentDetails.bank_to_receive || '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('cardlessPhone').value = paymentDetails.cardless_phone || '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('cardlessId').value = paymentDetails.cardless_id_check || '';
Â  Â  Â  Â  Â  Â  Â  Â  // Clear bank fields
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('#bankAccountFields input').forEach(input => input.value = '');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Store existing document URLs for reuse if files aren't changed
Â  Â  Â  Â  Â  Â  localStorage.setItem('existing_id_url', borrower.id_document_url || '');
Â  Â  Â  Â  Â  Â  localStorage.setItem('existing_statement_url', borrower.bank_statement_url || '');
Â  Â  Â  Â  Â  Â  localStorage.setItem('existing_address_url', borrower.proof_of_address_url || '');
Â  Â  Â  Â  Â  Â  localStorage.setItem('existing_selfie_url', borrower.selfie_document_url || '');
Â  Â  Â  Â  Â  Â  localStorage.setItem('existing_status', borrower.status); // Store old status for update logic
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- FORM SUBMISSION (UPDATED FOR EDIT/UPSERT) ---
Â  Â  document.getElementById('loanApplicationForm').addEventListener('submit', async e=>{
Â  Â  Â  Â  e.preventDefault(); e.stopPropagation();
Â  Â  Â  Â  // Re-enable ID number if disabled for submission
Â  Â  Â  Â  const idInput = document.getElementById('idNumber');
Â  Â  Â  Â  if (isEditMode) idInput.disabled = false;
Â  Â  Â  Â  
Â  Â  Â  Â  const submitBtn=e.target.querySelector('button[type="submit"]'); submitBtn.disabled=true;

Â  Â  Â  Â  // Fetch current values
Â  Â  Â  Â  const fullName=document.getElementById('fullName').value.trim();
Â  Â  Â  Â  const idNumber=idInput.value.trim();
Â  Â  Â  Â  const contactNumber=document.getElementById('contactNumber').value.trim();
Â  Â  Â  Â  const residentialAddress=document.getElementById('residentialAddress').value.trim();
Â  Â  Â  Â  const confirmationTick=document.getElementById('confirmationTick').checked;
Â  Â  Â  Â  const digitalSignature=document.getElementById('digitalSignature').value.trim();

Â  Â  Â  Â  if(!confirmationTick){ await customAlert('Validation Error','Tick the confirmation box.'); submitBtn.disabled=false; if(isEditMode) idInput.disabled=true; return; }
Â  Â  Â  Â  if(digitalSignature!=='YES'){ await customAlert('Validation Error','Type "YES" to sign digitally.'); submitBtn.disabled=false; if(isEditMode) idInput.disabled=true; return; }
Â  Â  Â  Â  if(!validateSAID(idNumber)){ await customAlert('Validation Error','Invalid SA ID number.'); submitBtn.disabled=false; if(isEditMode) idInput.disabled=true; return; }
Â  Â  Â  Â  if(!fullName || !contactNumber || !residentialAddress){ await customAlert('Validation Error','Complete all required fields.'); submitBtn.disabled=false; if(isEditMode) idInput.disabled=true; return; }

Â  Â  Â  Â  // PAYMENT METHOD
Â  Â  Â  Â  const bankInputs=document.querySelectorAll('#bankAccountFields input');
Â  Â  Â  Â  const cardlessInputs=document.querySelectorAll('#cardlessServiceFields input');
Â  Â  Â  Â  const isBank=isSectionFilled(bankInputs);
Â  Â  Â  Â  const isCardless=isSectionFilled(cardlessInputs);
Â  Â  Â  Â  let paymentValidation=null, selectedMethod=null, paymentDetails={};
Â  Â  Â  Â  if(isBank && isCardless) paymentValidation='Fill only one payment method.';
Â  Â  Â  Â  else if(!isBank && !isCardless) paymentValidation='Fill one payment method.';
Â  Â  Â  Â  else if(isBank){
Â  Â  Â  Â  Â  Â  selectedMethod='Bank Account';
Â  Â  Â  Â  Â  Â  paymentDetails={ bank_name:document.getElementById('bankName').value.trim(), account_number:document.getElementById('bankAccountNumber').value.trim(), linked_phone:document.getElementById('linkedPhone').value.trim() };
Â  Â  Â  Â  } else if(isCardless){
Â  Â  Â  Â  Â  Â  selectedMethod='Cardless Services';
Â  Â  Â  Â  Â  Â  const cardlessId=document.getElementById('cardlessId').value.trim();
Â  Â  Â  Â  Â  Â  if(!validateSAID(cardlessId)) paymentValidation='Invalid Cardless ID number.';
Â  Â  Â  Â  Â  Â  paymentDetails={ bank_to_receive:document.getElementById('cardlessBank').value.trim(), cardless_phone:document.getElementById('cardlessPhone').value.trim(), cardless_id_check:cardlessId };
Â  Â  Â  Â  }
Â  Â  Â  Â  if(paymentValidation){ await customAlert('Validation Error',paymentValidation); submitBtn.disabled=false; if(isEditMode) idInput.disabled=true; return; }

Â  Â  Â  Â  // FILE UPLOADS (Conditional on isEditMode)
Â  Â  Â  Â  let id_url = localStorage.getItem('existing_id_url');
Â  Â  Â  Â  let statement_url = localStorage.getItem('existing_statement_url');
Â  Â  Â  Â  let address_url = localStorage.getItem('existing_address_url');
Â  Â  Â  Â  let selfie_url = localStorage.getItem('existing_selfie_url');

Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const files={
Â  Â  Â  Â  Â  Â  Â  Â  idDocument: document.getElementById('idDocument').files[0],
Â  Â  Â  Â  Â  Â  Â  Â  bankStatement: document.getElementById('bankStatement').files[0],
Â  Â  Â  Â  Â  Â  Â  Â  proofOfAddress: document.getElementById('proofOfAddress').files[0],
Â  Â  Â  Â  Â  Â  Â  Â  selfieDocument: document.getElementById('selfieDocument').files[0]
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  showLoading(isEditMode ? "Updating data and checking files..." : "Uploading files...");

Â  Â  Â  Â  Â  Â  // Upload only if a new file is present. Reuse existing URL if in edit mode and no new file.
Â  Â  Â  Â  Â  Â  const timestamp=Date.now();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (files.idDocument) id_url = await uploadFile(files.idDocument, 'loan_documents', `${idNumber}/id-${timestamp}.${files.idDocument.name.split('.').pop()}`, true, isEditMode);
Â  Â  Â  Â  Â  Â  if (files.bankStatement) statement_url = await uploadFile(files.bankStatement, 'loan_documents', `${idNumber}/bank-${timestamp}.${files.bankStatement.name.split('.').pop()}`, false, isEditMode);
Â  Â  Â  Â  Â  Â  if (files.proofOfAddress) address_url = await uploadFile(files.proofOfAddress, 'loan_documents', `${idNumber}/address-${timestamp}.${files.proofOfAddress.name.split('.').pop()}`, true, isEditMode);
Â  Â  Â  Â  Â  Â  if (files.selfieDocument) selfie_url = await uploadFile(files.selfieDocument, 'loan_documents', `${idNumber}/selfie-${timestamp}.${files.selfieDocument.name.split('.').pop()}`, true, isEditMode);


Â  Â  Â  Â  Â  Â  // DATA STRUCTURE (RETAINS LOAN DETAILS)
Â  Â  Â  Â  Â  Â  const requestedAmount=parseFloat(localStorage.getItem('requestedLoanAmount'))||0;
Â  Â  Â  Â  Â  Â  const submissionDate=new Date();
Â  Â  Â  Â  Â  Â  const dueDate=new Date(submissionDate.getFullYear(),submissionDate.getMonth()+1,0).toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  const repaymentDays=Math.ceil((new Date(dueDate).getTime()-submissionDate.getTime())/(1000*60*60*24));

Â  Â  Â  Â  Â  Â  const dataObj={
Â  Â  Â  Â  Â  Â  Â  Â  id:idNumber, full_name:fullName, id_number:idNumber, contact_number:contactNumber, residential_address:residentialAddress,
Â  Â  Â  Â  Â  Â  Â  Â  employer_name:document.getElementById('employerName').value.trim()||null,
Â  Â  Â  Â  Â  Â  Â  Â  employee_address:document.getElementById('employeeAddress').value.trim()||null,
Â  Â  Â  Â  Â  Â  Â  Â  preferred_payment_type:selectedMethod,
Â  Â  Â  Â  Â  Â  Â  Â  payment_details_json:JSON.stringify(paymentDetails),
Â  Â  Â  Â  Â  Â  Â  Â  requested_amount:requestedAmount,
Â  Â  Â  Â  Â  Â  Â  Â  digital_signature:digitalSignature,
Â  Â  Â  Â  Â  Â  Â  Â  confirmed_accurate:confirmationTick,
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL: Reset status to 'Pending Review' for re-verification if user edited details
Â  Â  Â  Â  Â  Â  Â  Â  status: isEditMode ? 'Pending Review' : 'Pending Review', 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  repayment_due_date:dueDate,
Â  Â  Â  Â  Â  Â  Â  Â  repayment_period:repaymentDays,
Â  Â  Â  Â  Â  Â  Â  Â  interest_rate:0.50,
Â  Â  Â  Â  Â  Â  Â  Â  date_submitted:submissionDate.toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  id_document_url:id_url, // Use potentially new/existing URL
Â  Â  Â  Â  Â  Â  Â  Â  bank_statement_url:statement_url, // Use potentially new/existing URL
Â  Â  Â  Â  Â  Â  Â  Â  proof_of_address_url:address_url, // Use potentially new/existing URL
Â  Â  Â  Â  Â  Â  Â  Â  selfie_document_url:selfie_url // Use potentially new/existing URL
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  showLoading(isEditMode ? "Updating application data..." : "Inserting application data...");
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Choose between INSERT or UPSERT based on edit mode
Â  Â  Â  Â  Â  Â  let error;
Â  Â  Â  Â  Â  Â  if (isEditMode) {
Â  Â  Â  Â  Â  Â  Â  Â  // Update the existing row using the primary key (id_number)
Â  Â  Â  Â  Â  Â  Â  Â  ({ error } = await supabaseClient.from('borrowers').update(dataObj).eq('id_number', idNumber));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Insert a new row
Â  Â  Â  Â  Â  Â  Â  Â  ({ error } = await supabaseClient.from('borrowers').insert([dataObj]));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if(error) throw error;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  localStorage.setItem("currentUserId", idNumber); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  Â  Â  // Clear local storage of existing URLs after successful update
Â  Â  Â  Â  Â  Â  localStorage.removeItem('existing_id_url');
Â  Â  Â  Â  Â  Â  localStorage.removeItem('existing_statement_url');
Â  Â  Â  Â  Â  Â  localStorage.removeItem('existing_address_url');
Â  Â  Â  Â  Â  Â  localStorage.removeItem('existing_selfie_url');

Â  Â  Â  Â  Â  Â  await customAlert('Success', isEditMode ? 'Application details updated successfully!' : 'Application submitted successfully!');
Â  Â  Â  Â  Â  Â  window.location.href='dashboard.html';


Â  Â  Â  Â  } catch(err){
Â  Â  Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  Â  Â  await customAlert('Submission Failed',err.message);
Â  Â  Â  Â  Â  Â  submitBtn.disabled=false;
Â  Â  Â  Â  Â  Â  if(isEditMode) idInput.disabled=true;
Â  Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  // Run initialization when the document is ready
Â  Â  document.addEventListener('DOMContentLoaded', initForm);

</script>
</body>
</html>
