<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Application Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center; 
        min-height: 100vh;
        background-color: #f7f9fb;
    }
    .container {
        max-width: 600px;
        width: 95%;
        padding: 2.5rem;
        margin-top: 2rem; 
        margin-bottom: 4rem; 
        background-color: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    .form-group { margin-bottom: 1.25rem; }
    label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #1f2937; text-align: left; }
    .file-label-text { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    input[type="text"], input[type="number"], input[type="tel"], input[type="file"], select, textarea {
        width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: border-color 0.15s, box-shadow 0.15s; resize: vertical;
    }
    input:focus, select:focus, textarea:focus { border-color: #4f46e5; outline: 0; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    .custom-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
        display: flex; justify-content: center; align-items: center; z-index: 1001; transition: opacity 0.3s;
    }
    .custom-modal-content {
        background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .loading-overlay {
        position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9);
        display: flex; justify-content: center; align-items: center; z-index: 100; flex-direction: column; text-align: center;
    }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite; margin-bottom:1rem; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .payment-section-header { padding:0.75rem 0; margin-top:1.5rem; margin-bottom:0.5rem; font-size:1.125rem; font-weight:600; color:#1f2937; }
</style>
</head>
<body>

<!-- CUSTOM MODAL -->
<div id="custom-alert-modal" class="custom-modal hidden">
    <div class="custom-modal-content">
        <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Alert</h3>
        <div id="modal-message-container" class="text-gray-600 mb-6"><p id="modal-message"></p></div>
        <div id="modal-buttons" class="flex space-x-3 mt-4 justify-end">
            <button id="modal-cancel-button" class="hidden bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg focus:outline-none">Cancel</button>
            <button id="modal-ok-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg focus:outline-none">OK</button>
        </div>

    </div>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loader"></div>
    <p id="loading-message" class="text-lg font-semibold text-indigo-700">Submitting your application and uploading documents...</p>
    <p class="text-sm text-gray-600 mt-2">This may take a moment. Please do not close the window.</p>
</div>

<main class="container">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Loan Application Form</h1>
        <p class="text-gray-500 mt-2">Personal, Address, Employment, and Document Uploads</p>
    </header>

    <form id="loanApplicationForm" class="space-y-6">

        <!-- PERSONAL DETAILS -->
        <fieldset class="border p-4 rounded-lg shadow-sm">
            <legend class="text-lg font-semibold text-indigo-600 px-2">1. Personal Details</legend>
            <div class="form-group"><label for="fullName">Full Name</label><input type="text" id="fullName" required placeholder="e.g., Jane Doe"></div>
            <div class="form-group"><label for="idNumber">South African ID Number</label><input type="text" id="idNumber" required pattern="\d{13}" title="Must be a 13-digit ID number" placeholder="e.g., 9001015000087"></div>
            <div class="form-group"><label for="contactNumber">Contact Number</label><input type="tel" id="contactNumber" required pattern="\d{10}" title="Must be a 10-digit phone number" placeholder="e.g., 0712345678"></div>
        </fieldset>

        <!-- RESIDENTIAL ADDRESS -->
        <fieldset class="border p-4 rounded-lg shadow-sm">
            <legend class="text-lg font-semibold text-indigo-600 px-2">2. Residential Address</legend>
            <div class="form-group"><label for="residentialAddress">Physical Address (Must match Proof of Residence)</label><textarea id="residentialAddress" rows="3" required placeholder="Street Address, Suburb, City, Postal Code"></textarea></div>
        </fieldset>

        <!-- EMPLOYMENT DETAILS -->
       <!-- EMPLOYMENT DETAILS -->
<fieldset class="border p-4 rounded-lg shadow-sm">
    <legend class="text-lg font-semibold text-indigo-600 px-2">3. Employment Details</legend>
    <p class="text-sm text-gray-600 mb-4">Please complete if employed.</p>

    <div class="form-group">
        <label for="employerName">Employer Name</label>
        <input type="text" id="employerName" placeholder="e.g., ABC Pty Ltd">
    </div>

    <div class="form-group">
        <label for="employeeAddress">Employee Address</label>
        <textarea id="employeeAddress" rows="2" placeholder="e.g., 123 Main Street, Sandton"></textarea>
    </div>
</fieldset>


        <!-- PAYMENT PREFERENCE -->
        <fieldset class="border p-4 rounded-lg shadow-sm">
            <legend class="text-lg font-semibold text-indigo-600 px-2">4. Payment Preference</legend>
            <p class="text-sm text-gray-600 mb-4">Please fill out only one of the payment sections below.</p>

            <!-- Bank Account -->
            <div id="bankAccountFields">
                <h3 class="payment-section-header text-gray-800">üè¶ Bank Account Transfer</h3>
                <div class="p-3 border border-gray-300 rounded-lg">
                    <div class="form-group"><label for="bankName">Bank Name</label><input type="text" id="bankName" placeholder="e.g., FNB, Capitec, etc."></div>
                    <div class="form-group"><label for="bankAccountNumber">Bank Account Number</label><input type="text" id="bankAccountNumber" placeholder="Account Number"></div>
                    <div class="form-group"><label for="linkedPhone">Phone Number Linked to Bank Account</label><input type="tel" id="linkedPhone" placeholder="10-digit phone number"></div>
                </div>
            </div>

            <div class="my-6 border-t border-gray-300"></div>

            <!-- Cardless Services -->
            <div id="cardlessServiceFields">
                <h3 class="payment-section-header text-gray-800">üì≤ Cardless Services</h3>
                <div class="p-3 border border-gray-300 rounded-lg">
                    <div class="form-group"><label for="cardlessBank">Bank Name to receive Cardless Funds</label><input type="text" id="cardlessBank" placeholder="e.g., FNB, Capitec, etc."></div>
                    <div class="form-group"><label for="cardlessPhone">Phone Number for Cardless Service</label><input type="tel" id="cardlessPhone" placeholder="10-digit phone number"></div>
                    <div class="mt-4 p-3 border border-yellow-400 bg-yellow-50 rounded-lg text-sm text-gray-700">
                        <p class="font-bold text-yellow-800">Note:</p>
                        <p>We will use this phone number to send the Cardless Cash PIN if your application is approved.</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 p-4 border border-blue-400 bg-blue-50 rounded-lg text-sm text-gray-700">
                <p class="font-bold mb-2 text-blue-800">For Loan Repayment/Settlement (EFT) Reference:</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>Account Name: Savings Account</li>
                    <li>Bank: Capitec</li>
                    <li>Account Number: 1213614048</li>
                    <li>Branch Code: 470010</li>
                    <li>REFERENCE: Your Name</li>
                </ul>
            </div>
        </fieldset>

        <!-- DOCUMENTS -->
       <!-- DOCUMENTS -->
<fieldset class="border p-4 rounded-lg shadow-sm">
    <legend class="text-lg font-semibold text-indigo-600 px-2">5. Required Documents</legend>
    <p class="text-sm text-gray-600 mb-4">Upload clear copies (PDF/JPG).</p>

    <!-- Copy of ID Document -->
    <div class="form-group">
        <label for="idDocument">
            <span class="file-label-text">
                Copy of ID Document <span class="text-red-500 font-bold">(Compulsory)</span>
            </span>
        </label>
        <input type="file" id="idDocument" accept=".pdf,.jpg,.jpeg" required>
    </div>

    <!-- Latest Bank Statement -->
    <div class="form-group">
        <label for="bankStatement">
            <span class="file-label-text">
                Latest Bank Statement
            </span>
        </label>
        <input type="file" id="bankStatement" accept=".pdf,.jpg,.jpeg">
    </div>

    <!-- Proof of Residence -->
    <div class="form-group">
        <label for="proofOfAddress">
            <span class="file-label-text">
                Proof of Residence <span class="text-red-500 font-bold">(Compulsory)</span>
            </span>
        </label>
        <input type="file" id="proofOfAddress" accept=".pdf,.jpg,.jpeg" required>
    </div>

    <!-- Live Selfie -->
    <div class="form-group">
        <label for="selfieDocument">
            <span class="file-label-text">
                Your Live Selfie <span class="text-red-500 font-bold">(Compulsory)</span>
            </span>
        </label>
        <input type="file" id="selfieDocument" accept="image/*" required capture="user">
    </div>
</fieldset>


        <!-- FINAL CONFIRMATION -->
        <fieldset class="border p-4 rounded-lg shadow-sm bg-indigo-50">
            <legend class="text-lg font-semibold text-indigo-700 px-2">6. Final Confirmation</legend>
            <div class="form-group">
                <label class="flex items-start cursor-pointer p-3 border border-indigo-200 bg-white rounded-lg shadow-inner">
                    <input type="checkbox" id="confirmationTick" required class="mt-1 mr-3 h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="text-sm text-gray-800 font-medium">
                        I confirm all details are true and complete. I understand that any false statement may lead to rejection and legal action.
                    </span>
                </label>
            </div>
            <div class="form-group mt-6">
                <label for="digitalSignature" class="block text-base font-bold text-gray-900 mb-2">Type "YES" to digitally sign</label>
                <input type="text" id="digitalSignature" required placeholder="Type YES">
            </div>
        </fieldset>

        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-lg">Submit Application</button>
    </form>

    <div class="mt-8 text-center"><a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Cancel and Go to Home</a></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
    // Define your constants
    const SUPABASE_URL = 'https://kujvvupdqvtkncolhcul.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1anZ2dXBkcXZ0a25jb2xoY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM0MzgsImV4cCI6MjA3OTM3OTQzOH0.VBnQywbTQwwWFLmjUAZggfIWC1_J5opHdFwyqMDD3QE';

    // Create the client using the global variable 'supabase'
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Everything below this line is the rest of your original code
   function showLoading(msg) {
    document.getElementById('loading-message').textContent = msg;
    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Custom alert with optional Cancel button
function customAlert(title, msg, showCancel = false) {
    const modal = document.getElementById('custom-alert-modal');
    const okBtn = document.getElementById('modal-ok-button');
    const cancelBtn = document.getElementById('modal-cancel-button');

    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message-container').innerHTML = `<p>${msg}</p>`;

    if (showCancel) {
        cancelBtn.classList.remove('hidden');
        okBtn.classList.remove('w-full');
    } else {
        cancelBtn.classList.add('hidden');
        okBtn.classList.add('w-full');
    }

    modal.classList.remove('hidden');

    return new Promise((resolve) => {
        const okHandler = () => {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', okHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
            resolve(true); // OK clicked
        };
        const cancelHandler = () => {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', okHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
            resolve(false); // Cancel clicked
        };

        okBtn.addEventListener('click', okHandler);
        cancelBtn.addEventListener('click', cancelHandler);
    });
}

function validateSAID(id) { return /^\d{13}$/.test(id); }
function isSectionFilled(inputs) { return Array.from(inputs).every(i => i.value.trim() !== ''); }

async function uploadFile(file, bucket, path, isRequired = true) {
    if (!file) {
        if (isRequired) throw new Error("Required file missing");
        return null;
    }
    const { data, error } = await supabaseClient.storage.from(bucket).upload(path, file, { upsert: false });
    if (error) throw new Error(error.message);
    const { data: publicUrlData } = supabaseClient.storage.from(bucket).getPublicUrl(data.path);
    return publicUrlData.publicUrl;
}

// FORM SUBMISSION
document.getElementById('loanApplicationForm').addEventListener('submit', async e => {
    e.preventDefault();
    e.stopPropagation();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;

    // Collect form data
    const fullName = document.getElementById('fullName').value.trim();
    const idNumber = document.getElementById('idNumber').value.trim();
    const contactNumber = document.getElementById('contactNumber').value.trim();
    const residentialAddress = document.getElementById('residentialAddress').value.trim();
    const employerName = document.getElementById('employerName').value.trim() || null;
    const employeeAddress = document.getElementById('employeeAddress').value.trim() || null;
    const confirmationTick = document.getElementById('confirmationTick').checked;
    const digitalSignature = document.getElementById('digitalSignature').value.trim();

    // Basic validations
    if (!confirmationTick) { await customAlert('Validation Error', 'Tick the confirmation box.'); submitBtn.disabled = false; return; }
    if (digitalSignature !== 'YES') { await customAlert('Validation Error', 'Type "YES" to sign digitally.'); submitBtn.disabled = false; return; }
    if (!validateSAID(idNumber)) { await customAlert('Validation Error', 'Invalid SA ID number.'); submitBtn.disabled = false; return; }
    if (!fullName || !contactNumber || !residentialAddress) { await customAlert('Validation Error', 'Complete all required fields.'); submitBtn.disabled = false; return; }

    // Payment method
    const bankInputs = document.querySelectorAll('#bankAccountFields input');
    const cardlessInputs = document.querySelectorAll('#cardlessServiceFields input');

    const isBank = Array.from(bankInputs).every(i => i.value.trim() !== '');
    const isCardless = Array.from(cardlessInputs).every(i => i.value.trim() !== '');

    let selectedMethod = null;
    let paymentDetails = {};
    let paymentValidation = null;

    if (isBank && isCardless) paymentValidation = 'Fill only one payment method.';
    else if (!isBank && !isCardless) paymentValidation = 'Fill one payment method.';
    else if (isBank) {
        selectedMethod = 'Bank Account';
        paymentDetails = {
            bank_name: document.getElementById('bankName').value.trim(),
            account_number: document.getElementById('bankAccountNumber').value.trim(),
            linked_phone: document.getElementById('linkedPhone').value.trim()
        };
    } else if (isCardless) {
        selectedMethod = 'Cardless Services';
        paymentDetails = {
            bank_to_receive: document.getElementById('cardlessBank').value.trim(),
            cardless_phone: document.getElementById('cardlessPhone').value.trim()
        };
    }

    if (paymentValidation) { await customAlert('Validation Error', paymentValidation); submitBtn.disabled = false; return; }

    // Prepare summary for confirmation popup
    const summary = `
Full Name: ${fullName}
ID Number: ${idNumber}
Contact Number: ${contactNumber}
Residential Address: ${residentialAddress}
Employer Name: ${employerName || 'N/A'}
Employee Address: ${employeeAddress || 'N/A'}
Payment Method: ${selectedMethod || 'N/A'}
    `;

    // Show confirmation popup with Cancel option
    const confirmSubmission = await customAlert('Please Confirm Your Details', summary, true);

    if (!confirmSubmission) { // user clicked Cancel
        submitBtn.disabled = false;
        return;
    }

    // File uploads and submission
    showLoading("Uploading files...");
    try {
        const files = {
            idDocument: document.getElementById('idDocument').files[0],
            bankStatement: document.getElementById('bankStatement').files[0],
            proofOfAddress: document.getElementById('proofOfAddress').files[0],
            selfieDocument: document.getElementById('selfieDocument').files[0]
        };

        const timestamp = Date.now();
        const id_url = await uploadFile(files.idDocument, 'loan_documents', `${idNumber}/id-${timestamp}.${files.idDocument.name.split('.').pop()}`, true);
        const statement_url = files.bankStatement ? await uploadFile(files.bankStatement, 'loan_documents', `${idNumber}/bank-${timestamp}.${files.bankStatement.name.split('.').pop()}`, false) : null;
        const address_url = await uploadFile(files.proofOfAddress, 'loan_documents', `${idNumber}/address-${timestamp}.${files.proofOfAddress.name.split('.').pop()}`, true);
        const selfie_url = await uploadFile(files.selfieDocument, 'loan_documents', `${idNumber}/selfie-${timestamp}.${files.selfieDocument.name.split('.').pop()}`, true);

        // Data insert
        const requestedAmount = parseFloat(localStorage.getItem('requestedLoanAmount')) || 0;
        const submissionDate = new Date();
        const dueDate = new Date(submissionDate.getFullYear(), submissionDate.getMonth() + 1, 0).toISOString().split('T')[0];
        const repaymentDays = Math.ceil((new Date(dueDate).getTime() - submissionDate.getTime()) / (1000 * 60 * 60 * 24));

        const dataObj = {
            id: idNumber,
            full_name: fullName,
            id_number: idNumber,
            contact_number: contactNumber,
            residential_address: residentialAddress,
            employer_name: employerName,
            employee_address: employeeAddress,
            preferred_payment_type: selectedMethod,
            payment_details_json: JSON.stringify(paymentDetails),
            requested_amount: requestedAmount,
            digital_signature: digitalSignature,
            confirmed_accurate: confirmationTick,
            status: 'Pending Review',
            repayment_due_date: dueDate,
            repayment_period: repaymentDays,
            interest_rate: 0.50,
            date_submitted: submissionDate.toISOString(),
            id_document_url: id_url,
            bank_statement_url: statement_url,
            proof_of_address_url: address_url,
            selfie_document_url: selfie_url
        };

        showLoading("Submitting application...");
        const { error } = await supabaseClient.from('borrowers').insert([dataObj]);
        if (error) throw error;

        localStorage.setItem("currentUserId", idNumber);
        hideLoading();
        await customAlert('Success', 'Application submitted successfully!');
        window.location.href = 'dashboard.html';

    } catch (err) {
        hideLoading();
        await customAlert('Submission Failed', err.message);
        submitBtn.disabled = false;
    }
});
</script>
</body>
</html>










