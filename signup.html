<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Loan Application Form</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  Â  Â  Â  align-items: center; /* Centers the container horizontally */
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  background-color: #f7f9fb;
Â  Â  Â  Â  }
Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  /* ðŸŽ¯ FIX: Remove 'auto' horizontal margin if body is flex, and control top/bottom space explicitly. */
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  width: 95%;
Â  Â  Â  Â  Â  Â  padding: 2.5rem;
Â  Â  Â  Â  Â  Â  /* Explicitly set top margin for spacing from the top of the viewport. */
Â  Â  Â  Â  Â  Â  margin-top: 2rem; 
Â  Â  Â  Â  Â  Â  /* Add extra bottom margin for a better footer gap */
Â  Â  Â  Â  Â  Â  margin-bottom: 4rem; 
Â  Â  Â  Â  Â  Â  margin-left: auto; /* Re-add auto margins to be safe, but align-items: center handles centering */
Â  Â  Â  Â  Â  Â  margin-right: auto;
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group {
Â  Â  Â  Â  Â  Â  margin-bottom: 1.25rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  label {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  Â  Â  Â  color: #1f2937;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* New Style to ensure file labels align consistently */
Â  Â  Â  Â  .file-label-text {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }
Â  Â  Â  Â  input[type="file"] {
Â  Â  Â  Â  Â  Â  /* Adjust padding for file inputs to better match others */
Â  Â  Â  Â  Â  Â  padding-top: 0.5rem;
Â  Â  Â  Â  Â  Â  padding-bottom: 0.5rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  input[type="text"],
Â  Â  Â  Â  input[type="number"],
Â  Â  Â  Â  input[type="tel"],
Â  Â  Â  Â  input[type="file"],
Â  Â  Â  Â  select,
Â  Â  Â  Â  textarea {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 0.75rem;
Â  Â  Â  Â  Â  Â  border: 1px solid #d1d5db;
Â  Â  Â  Â  Â  Â  border-radius: 0.375rem;
Â  Â  Â  Â  Â  Â  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
Â  Â  Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  }
Â  Â  Â  Â  input:focus,
Â  Â  Â  Â  select:focus,
Â  Â  Â  Â  textarea:focus {
Â  Â  Â  Â  Â  Â  border-color: #4f46e5;
Â  Â  Â  Â  Â  Â  outline: 0;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Custom Modal Styles (MUST be used instead of alert()) */
Â  Â  Â  Â  .custom-modal {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.6);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  z-index: 1001;
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-modal-content {
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  .loading-overlay {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(255, 255, 255, 0.9);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .loader {
Â  Â  Â  Â  Â  Â  border: 4px solid #f3f3f3;
Â  Â  Â  Â  Â  Â  border-top: 4px solid #4f46e5;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 40px;
Â  Â  Â  Â  Â  Â  height: 40px;
Â  Â  Â  Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â Â 
Â  Â  <div id="custom-alert-modal" class="custom-modal hidden">
Â  Â  Â  Â  <div class="custom-modal-content">
Â  Â  Â  Â  Â  Â  <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Alert</h3>
Â  Â  Â  Â  Â  Â  <p id="modal-message" class="text-gray-600 mb-6"></p>
Â  Â  Â  Â  Â  Â  <button id="modal-ok-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
Â  Â  Â  Â  Â  Â  Â  Â  OK
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <main class="container">
Â  Â  Â  Â  <header class="text-center mb-8">
Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-gray-900">Loan Application Form</h1>
Â  Â  Â  Â  Â  Â  <p class="text-gray-500 mt-2">Personal, Address, Employment, and Document Uploads</p>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <form id="loanApplicationForm" class="space-y-6">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">1. Personal Details</legend>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="fullName">Full Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fullName" required placeholder="e.g., Jane Doe">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="idNumber">South African ID Number</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="idNumber" required pattern="\d{13}" title="Must be a 13-digit ID number" placeholder="e.g., 9001015000087">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="contactNumber">Contact Number</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="contactNumber" required pattern="\d{10}" title="Must be a 10-digit phone number" placeholder="e.g., 0712345678">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">2. Residential Address</legend>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="residentialAddress">Physical Address (Must match Proof of Residence)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="residentialAddress" rows="3" required placeholder="Street Address, Suburb, City, Postal Code"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">3. Employment Details <span class="text-gray-500 text-sm">(All fields below are optional)</span></legend>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="employerName">Employer Name <span class="text-gray-500 font-medium">(Optional)</span></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="employerName" placeholder="e.g., ABC Pty Ltd">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="employeeAddress">Employee's Address <span class="text-gray-500 font-medium">(Optional)</span></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="employeeAddress" rows="2" placeholder="e.g., 123 Main Street, Sandton"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </fieldset>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">4. Payment Preference</legend>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="paymentMethod">How would you like to be paid?</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="paymentMethod" required class="cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" disabled selected>Select a payment method...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Bank Account">Bank Account (EFT)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="eWallet">eWallet (Instant Transfer)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="CashSend">CashSend (PIN Redemption)</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="paymentDetailsContainer" class="mt-4 p-4 border border-dashed border-gray-300 rounded-lg bg-gray-50 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-gray-700 mb-3">Payment Details:</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="mt-6 p-4 border border-blue-400 bg-blue-50 rounded-lg text-sm text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold mb-2 text-blue-800">For Loan Repayment/Settlement (EFT) Reference:</p>
Â  Â  Â  Â  Â  Â  Â  Â  <ul class="list-disc list-inside space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Account Name: Savings Account</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Bank: Capitec</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Account Number: 1213614048</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Branch Code: 470010</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>REFERENCE: Your Name</li>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-600 px-2">5. Required Documents</legend>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-4">Please upload clear, legible copies (PDF or JPG format).</p>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="idDocument">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-label-text">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Copy of ID Document <span class="text-red-500 font-bold">(Compulsory)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="idDocument" accept=".pdf,.jpg,.jpeg" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="bankStatement">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="file-label-text">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Latest Bank Statement (Proof of Income) <span class="text-gray-500 font-medium">(Optional)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="bankStatement" accept=".pdf,.jpg,.jpeg">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="proofOfAddress">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-label-text">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Proof of Residence (e.g., Utility Bill) <span class="text-red-500 font-bold">(Compulsory)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="proofOfAddress" accept=".pdf,.jpg,.jpeg" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="selfieDocument">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-label-text">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Live Selfie <span class="text-red-500 font-bold">(Compulsory - Camera Only)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="selfieDocument" accept="image/*" required capture="user">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  <fieldset class="border p-4 rounded-lg shadow-sm bg-indigo-50">
Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-lg font-semibold text-indigo-700 px-2">6. Final Confirmation</legend>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-start cursor-pointer p-3 border border-indigo-200 bg-white rounded-lg shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="confirmationTick" required class="mt-1 mr-3 h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-gray-800 font-medium">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  I confirm that all details provided in this loan application are true, accurate, and complete to the best of my knowledge and belief. I understand that any false statement or omission may lead to the rejection of my application, withdrawal of any agreement, and potential legal action.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="digitalSignature" class="block text-base font-bold text-gray-900 mb-2">Type "YES" to digitally sign the application</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="digitalSignature" required placeholder="Type YES in capital letters">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </fieldset>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Submit Application
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <div class="mt-8 text-center">
Â  Â  Â  Â  Â  Â  <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Cancel and Go to Home</a>
Â  Â  Â  Â  </div>
Â  Â  </main>

Â  Â  <div id="loadingOverlay" class="loading-overlay hidden">
Â  Â  Â  Â  <div class="loader"></div>
Â  Â  Â  Â  <p id="loading-message" class="text-lg font-semibold text-indigo-700">Submitting your application and uploading documents...</p>
Â  Â  Â  Â  <p class="text-sm text-gray-600 mt-2">This may take a moment. Please do not close the window.</p>
Â  Â  </div>
Â  Â Â 
<script type="module">
// START OF REQUIRED FIREBASE & SUPABASE SETUP
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// --- Global Variables (Provided by Canvas) ---
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Firebase Init (Used for Authentication/User Context) ---
let auth;
if (Object.keys(firebaseConfig).length > 0) {
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  auth = getAuth(app);
Â  Â  if (initialAuthToken) {
Â  Â  Â  Â  signInWithCustomToken(auth, initialAuthToken).catch(e => {
Â  Â  Â  Â  Â  Â  console.error("Firebase custom sign-in failed:", e);
Â  Â  Â  Â  Â  Â  signInAnonymously(auth);
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  signInAnonymously(auth);
Â  Â  }
} else {
Â  Â  console.warn("Firebase configuration not found. Skipping Firebase initialization.");
}

// --- Supabase Config ---
const SUPABASE_URL = 'https://kujvvupdqvtkncolhcul.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1anZ2dXBkcXZ0a25jb2xoY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM0MzgsImV4cCI6MjA3OTM3OTQzOH0.VBnQywbTQwwWFLmjUAZggfIWC1_J5opHdFwyqMDD3QE';

export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function goToPage(page) {
Â  Â  window.location.href = page;
}
// END OF REQUIRED FIREBASE & SUPABASE SETUP

// --- UTILITY FUNCTIONS (Moved up for better structure) ---

/**
Â * Custom modal replacement for alert()
Â * @param {string} title
Â * @param {string} message
Â */
function customAlert(title, message) {
Â  Â  const modal = document.getElementById('custom-alert-modal');
Â  Â  document.getElementById('modal-title').textContent = title;
Â  Â  document.getElementById('modal-message').textContent = message;
Â  Â  modal.classList.remove('hidden');

Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  const okButton = document.getElementById('modal-ok-button');
Â  Â  Â  Â  const handler = () => {
Â  Â  Â  Â  Â  Â  modal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  okButton.removeEventListener('click', handler);
Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  };
Â  Â  Â  Â  okButton.addEventListener('click', handler);
Â  Â  });
}

/**
Â * Shows the loading overlay with a specific message.
Â * @param {string} messageÂ 
Â */
function showLoading(message) {
Â  Â  document.getElementById('loading-message').textContent = message;
Â  Â  document.getElementById('loadingOverlay').classList.remove('hidden');
Â  Â  document.body.style.overflow = 'hidden';
}

/**
Â * Hides the loading overlay.
Â */
function hideLoading() {
Â  Â  document.getElementById('loadingOverlay').classList.add('hidden');
Â  Â  document.body.style.overflow = 'auto';
}


/**
Â * Uploads a file to Supabase Storage and returns the public URL.
Â * @param {File} file The file object to upload.
Â * @param {string} bucket The Supabase Storage bucket name.
Â * @param {string} path The path within the bucket (e.g., 'documents/user-id/id-doc.pdf').
Â * @param {boolean} isRequired Whether the file is mandatory.
Â * @returns {Promise<string | null>} The public URL of the uploaded file, or null if file is optional and not provided.
Â */
async function uploadFile(file, bucket, path, isRequired = true) {
Â  Â  if (!file) {
Â  Â  Â  Â  if (isRequired) {
Â  Â  Â  Â  Â  Â  throw new Error("A compulsory file was not provided for upload.");
Â  Â  Â  Â  }
Â  Â  Â  Â  // If optional and not provided, return null
Â  Â  Â  Â  return null;
Â  Â  }
Â  Â Â 
Â  Â  // Upload the file
Â  Â  const { data, error } = await supabase.storage
Â  Â  Â  Â  .from(bucket)
Â  Â  Â  Â  .upload(path, file, {
Â  Â  Â  Â  Â  Â  cacheControl: '3600',
Â  Â  Â  Â  Â  Â  upsert: falseÂ 
Â  Â  Â  Â  });

Â  Â  if (error) {
Â  Â  Â  Â  console.error('Supabase upload error:', error);
Â  Â  Â  Â  throw new Error('File upload failed: ' + error.message);
Â  Â  }

Â  Â  // Get the public URL for the uploaded file
Â  Â  const { data: publicUrlData } = supabase.storage
Â  Â  Â  Â  .from(bucket)
Â  Â  Â  Â  .getPublicUrl(data.path);
Â  Â  Â  Â Â 
Â  Â  if (!publicUrlData || !publicUrlData.publicUrl) {
Â  Â  Â  Â  throw new Error('Could not retrieve public URL after successful upload.');
Â  Â  }

Â  Â  return publicUrlData.publicUrl;
}

// --- DYNAMIC PAYMENT FIELD LOGIC (This logic is correct and was likely just skipped due to other errors) ---
document.addEventListener('DOMContentLoaded', () => {
Â  Â  const paymentMethod = document.getElementById('paymentMethod');
Â  Â  const container = document.getElementById('paymentDetailsContainer');

Â  Â  const fields = {
Â  Â  Â  Â  'Bank Account': `
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="bankName">Bank Name (Where funds will be deposited)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="bankName" required placeholder="e.g., FNB, Standard Bank">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="bankAccountNumber">Bank Account Number</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="bankAccountNumber" required pattern="\\d+" title="Only digits are allowed" placeholder="e.g., 1234567890">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `,
Â  Â  Â  Â  'eWallet': `
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="eWalletProvider">eWallet Provider (e.g., FNB, Capitec)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="eWalletProvider" required placeholder="e.g., FNB, Capitec">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="eWalletPhoneNumber">eWallet Registered Phone Number</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="eWalletPhoneNumber" required pattern="\\d{10}" title="Must be a 10-digit phone number" placeholder="e.g., 0712345678">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `,
Â  Â  Â  Â  'CashSend': `
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="cashSendBank">CashSend Bank (e.g., FNB, Standard Bank)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="cashSendBank" required placeholder="e.g., FNB, Standard Bank">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="cashSendPhoneNumber">Recipient Phone Number (For SMS notification)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="cashSendPhoneNumber" required pattern="\\d{10}" title="Must be a 10-digit phone number" placeholder="e.g., 0712345678">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `
Â  Â  };

Â  Â  paymentMethod.addEventListener('change', (e) => {
Â  Â  Â  Â  const selected = e.target.value;
Â  Â  Â  Â  if (selected && fields[selected]) {
Â  Â  Â  Â  Â  Â  container.innerHTML = fields[selected];
Â  Â  Â  Â  Â  Â  container.classList.remove('hidden');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â  container.classList.add('hidden');
Â  Â  Â  Â  }
Â  Â  });
});
// --- END DYNAMIC PAYMENT FIELD LOGIC ---


// Main submission handler
document.getElementById('loanApplicationForm').addEventListener('submit', async function(event) {
Â  Â  event.preventDefault();
Â  Â Â 
Â  Â  // --- 0. Pre-Submission and Final Confirmation Validation ---
Â  Â  const confirmationTick = document.getElementById('confirmationTick');
Â  Â  const digitalSignature = document.getElementById('digitalSignature').value.trim();
Â  Â  const selectedMethod = document.getElementById('paymentMethod').value;


Â  Â  if (!confirmationTick.checked) {
Â  Â  Â  Â  await customAlert('Validation Error', 'You must tick the confirmation box to confirm all details are true and accurate.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (digitalSignature !== 'YES') {
Â  Â  Â  Â  await customAlert('Validation Error', 'You must digitally sign the application by typing "YES" in capital letters.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (!selectedMethod) {
Â  Â  Â  Â  await customAlert('Validation Error', 'Please select a preferred payment method.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // --- Payment Details Validation & Data Extraction (CRUCIAL FIX) ---
Â  Â  let paymentDetails = {};
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  if (selectedMethod === 'Bank Account') {
Â  Â  Â  Â  Â  Â  // Ensure element exists and value is trimmed
Â  Â  Â  Â  Â  Â  const bankName = document.getElementById('bankName')?.value.trim();
Â  Â  Â  Â  Â  Â  const bankAccountNumber = document.getElementById('bankAccountNumber')?.value.trim();
Â  Â  Â  Â  Â  Â  if (!bankName || !bankAccountNumber) throw new Error('Bank Account details are incomplete or missing.');
Â  Â  Â  Â  Â  Â  paymentDetails = { name: bankName, account: bankAccountNumber };
Â  Â  Â  Â  } else if (selectedMethod === 'eWallet') {
Â  Â  Â  Â  Â  Â  const provider = document.getElementById('eWalletProvider')?.value.trim();
Â  Â  Â  Â  Â  Â  const phone = document.getElementById('eWalletPhoneNumber')?.value.trim();
Â  Â  Â  Â  Â  Â  if (!provider || !phone) throw new Error('eWallet details are incomplete or missing.');
Â  Â  Â  Â  Â  Â  paymentDetails = { provider: provider, phone: phone };
Â  Â  Â  Â  } else if (selectedMethod === 'CashSend') {
Â  Â  Â  Â  Â  Â  const bank = document.getElementById('cashSendBank')?.value.trim();
Â  Â  Â  Â  Â  Â  const phone = document.getElementById('cashSendPhoneNumber')?.value.trim();
Â  Â  Â  Â  Â  Â  if (!bank || !phone) throw new Error('CashSend details are incomplete or missing.');
Â  Â  Â  Â  Â  Â  paymentDetails = { bank: bank, phone: phone };
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  await customAlert('Validation Error', e.message);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  // --- END Payment Details Validation ---

Â  Â  // Now that validation is complete, show loading
Â  Â  showLoading("Submitting application and starting file uploads...");

Â  Â  const idNumberInput = document.getElementById('idNumber');
Â  Â  const borrowerId = idNumberInput.value.trim(); // Use ID number as the unique identifier

Â  Â  const requestedAmountString = localStorage.getItem('requestedLoanAmount');
Â  Â  if (!requestedAmountString) {
Â  Â  Â  Â  await customAlert('Error', 'Requested loan amount not found. Please restart the process.');
Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  goToPage('agreement.html');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  // --- Get Optional Employment Values (Use || null to handle empty strings for Supabase) ---
Â  Â  Â  Â  const employerName = document.getElementById('employerName').value.trim();
Â  Â  Â  Â  const employeeAddress = document.getElementById('employeeAddress').value.trim();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Get all form values
Â  Â  Â  Â  const data = {
Â  Â  Â  Â  Â  Â  id: borrowerId, // IMPORTANT: Use ID Number as primary key
Â  Â  Â  Â  Â  Â  full_name: document.getElementById('fullName').value,
Â  Â  Â  Â  Â  Â  id_number: borrowerId, // Store ID number in its own column too
Â  Â  Â  Â  Â  Â  contact_number: document.getElementById('contactNumber').value,
Â  Â  Â  Â  Â  Â  residential_address: document.getElementById('residentialAddress').value,
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- CORRECTED EMPLOYMENT FIELDS (Ensures null if not provided) ---
Â  Â  Â  Â  Â  Â  employer_name: employerName || null,Â 
Â  Â  Â  Â  Â  Â  employee_address: employeeAddress || null,Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- CORRECTED NEW PAYMENT FIELDS ---
Â  Â  Â  Â  Â  Â  preferred_payment_type: selectedMethod,
Â  Â  Â  Â  Â  Â  payment_details_json: JSON.stringify(paymentDetails), // Store the object as JSON text
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // REQUEST DATA
Â  Â  Â  Â  Â  Â  requested_amount: parseFloat(requestedAmountString),
Â  Â  Â  Â  Â  Â  // Confirmation Data
Â  Â  Â  Â  Â  Â  digital_signature: digitalSignature,
Â  Â  Â  Â  Â  Â  confirmed_accurate: confirmationTick.checked,
Â  Â  Â  Â  Â  Â  // Default values - MATCHING CONFIRMED COLUMN NAMES
Â  Â  Â  Â  Â  Â  status: 'Pending Review',
Â  Â  Â  Â  Â  Â  repayment_period: 30, // Default 30 days
Â  Â  Â  Â  Â  Â  interest_rate: 0.50, // Default 50%
Â  Â  Â  Â  Â  Â  date_submitted: new Date().toISOString()
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. Prepare files for upload
Â  Â  Â  Â  const files = {
Â  Â  Â  Â  Â  Â  idDocument: document.getElementById('idDocument').files[0],
Â  Â  Â  Â  Â  Â  bankStatement: document.getElementById('bankStatement').files[0],
Â  Â  Â  Â  Â  Â  proofOfAddress: document.getElementById('proofOfAddress').files[0],
Â  Â  Â  Â  Â  Â  selfieDocument: document.getElementById('selfieDocument').files[0]
Â  Â  Â  Â  };

Â  Â  Â  Â  // 3. Upload all files and collect URLs
Â  Â  Â  Â Â 
Â  Â  Â  Â  showLoading("Uploading compulsory document 1 of 3: ID Document...");
Â  Â  Â  Â  const idPromise = uploadFile(files.idDocument, 'loan_documents', `${borrowerId}/id-document-${Date.now()}`, true); // Required
Â  Â  Â  Â Â 
Â  Â  Â  Â  showLoading("Uploading optional document: Bank Statement...");
Â  Â  Â  Â  const statementPromise = uploadFile(files.bankStatement, 'loan_documents', `${borrowerId}/bank-statement-${Date.now()}`, false); // Optional
Â  Â  Â  Â Â 
Â  Â  Â  Â  showLoading("Uploading compulsory document 2 of 3: Proof of Address...");
Â  Â  Â  Â  const addressPromise = uploadFile(files.proofOfAddress, 'loan_documents', `${borrowerId}/proof-of-address-${Date.now()}`, true); // Required
Â  Â  Â  Â Â 
Â  Â  Â  Â  showLoading("Uploading compulsory document 3 of 3: Live Selfie...");
Â  Â  Â  Â  const selfiePromise = uploadFile(files.selfieDocument, 'loan_documents', `${borrowerId}/document-selfie-${Date.now()}`, true); // Required

Â  Â  Â  Â  // Wait for all uploads to complete
Â  Â  Â  Â  const [id_url, statement_url, address_url, selfie_url] = await Promise.all([
Â  Â  Â  Â  Â  Â  idPromise,
Â  Â  Â  Â  Â  Â  statementPromise,
Â  Â  Â  Â  Â  Â  addressPromise,
Â  Â  Â  Â  Â  Â  selfiePromise
Â  Â  Â  Â  ]);

Â  Â  Â  Â  // 4. Update data object with document URLs (statement_url might be null now)
Â  Â  Â  Â  data.document_id_url = id_url;
Â  Â  Â  Â  data.document_bank_url = statement_url;
Â  Â  Â  Â  data.document_address_url = address_url;
Â  Â  Â  Â  data.document_selfie_url = selfie_url;

Â  Â  Â  Â  showLoading("Inserting application data into the database...");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 5. Insert data into the 'borrowers' table
Â  Â  Â  Â  const { error: insertError } = await supabase
Â  Â  Â  Â  Â  Â  .from('borrowers')
Â  Â  Â  Â  Â  Â  .insert([
Â  Â  Â  Â  Â  Â  Â  Â  { ...data }
Â  Â  Â  Â  Â  Â  ]);

Â  Â  Â  Â  if (insertError) {
Â  Â  Â  Â  Â  Â  console.error('Supabase Insert Error:', insertError);
Â  Â  Â  Â  Â  Â  throw new Error('Database submission failed: ' + insertError.message);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 6. Success: Save the new ID and redirect
Â  Â  Â  Â  localStorage.setItem('currentUserId', borrowerId);
Â  Â  Â  Â  localStorage.removeItem('requestedLoanAmount'); // Clear the temporary amount
Â  Â  Â  Â Â 
Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  await customAlert('Success', `Application Submitted! Your ID is ${borrowerId}. You will now be redirected to your dashboard.`);
Â  Â  Â  Â  goToPage('dashboard.html');

Â  Â  } catch (error) {
Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  console.error('Application Submission Error:', error);
Â  Â  Â  Â  await customAlert('Submission Failed', `An error occurred during submission. Details: ${error.message}`);
Â  Â  }
});
</script>
</body>
</html>
