<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Application Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 600px;
            width: 95%;
            padding: 2.5rem;
            margin-top: 2rem;
            margin-bottom: 4rem;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #1f2937; text-align: left; }
        .file-label-text { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        input[type="file"] { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        input[type="text"], input[type="number"], input[type="tel"], input[type="file"], select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            resize: vertical;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #4f46e5;
            outline: 0;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .custom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1001; transition: opacity 0.3s; }
        .custom-modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:100; flex-direction: column; text-align:center; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="custom-alert-modal" class="custom-modal hidden">
    <div class="custom-modal-content">
        <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Alert</h3>
        <div id="modal-message-container" class="text-gray-600 mb-6">
            <p id="modal-message"></p>
        </div>
        <div class="flex space-x-3 mt-4">
            <button id="modal-cancel-button" class="w-1/2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline hidden">Cancel</button>
            <button id="modal-ok-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">OK</button>
        </div>
    </div>
</div>

<main class="container">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Loan Application Form</h1>
        <p class="text-gray-500 mt-2">Personal, Address, Employment, and Document Uploads</p>
    </header>

    <form id="loanApplicationForm" class="space-y-6">
        <!-- Personal Details, Address, Employment, Payment, Documents, Confirmation -->
        <!-- For brevity, keep your existing fields as is from your original code -->
        <!-- Just ensure IDs are the same for all required fields -->
        <!-- ... -->
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-lg">Submit Application</button>
    </form>

    <div class="mt-8 text-center">
        <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Cancel and Go to Home</a>
    </div>
</main>

<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loader"></div>
    <p id="loading-message" class="text-lg font-semibold text-indigo-700">Submitting your application and uploading documents...</p>
    <p class="text-sm text-gray-600 mt-2">This may take a moment. Please do not close the window.</p>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ---------- CRITICAL GUARD AGAINST LOOPING ----------
const requestedAmount = localStorage.getItem('requestedLoanAmount');
if (!requestedAmount) {
    console.warn("Requested loan amount missing. Redirecting to agreement page.");
    window.location.replace('agreement.html');
    throw new Error("No requested loan amount found. Redirected to agreement.html."); 
}

// ---------- SUPABASE INIT ----------
const SUPABASE_URL = 'https://kujvvupdqvtkncolhcul.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---------- MODAL UTILITY ----------
function customConfirmationAlert(title, messageHtml, okText='OK', cancelText=null) {
    const modal = document.getElementById('custom-alert-modal');
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message-container').innerHTML = messageHtml;
    const okButton = document.getElementById('modal-ok-button');
    const cancelButton = document.getElementById('modal-cancel-button');
    okButton.textContent = okText;
    if(cancelText){ cancelButton.textContent = cancelText; cancelButton.classList.remove('hidden'); okButton.classList.add('w-1/2'); cancelButton.classList.add('w-1/2'); } 
    else { cancelButton.classList.add('hidden'); okButton.classList.add('w-full'); }
    modal.classList.remove('hidden');
    return new Promise(resolve=>{
        const okHandler=()=>{ modal.classList.add('hidden'); okButton.removeEventListener('click',okHandler); if(cancelText) cancelButton.removeEventListener('click',cancelHandler); resolve('ok'); };
        const cancelHandler=()=>{ modal.classList.add('hidden'); okButton.removeEventListener('click',okHandler); cancelButton.removeEventListener('click',cancelHandler); resolve('cancel'); };
        okButton.addEventListener('click',okHandler);
        if(cancelText) cancelButton.addEventListener('click',cancelHandler);
    });
}
function customAlert(title,message){ return customConfirmationAlert(title, `<p>${message}</p>`); }

function showLoading(msg){ document.getElementById('loading-message').textContent = msg; document.getElementById('loadingOverlay').classList.remove('hidden'); document.body.style.overflow='hidden'; }
function hideLoading(){ document.getElementById('loadingOverlay').classList.add('hidden'); document.body.style.overflow='auto'; }

function goToPage(page){ window.location.href = page; }

// ---------- FORM SUBMISSION ----------
document.getElementById('loanApplicationForm').addEventListener('submit', async function(event){
    event.preventDefault();
    showLoading("Processing application...");
    try{
        // --- Extract Values & Validate ---
        const fullName = document.getElementById('fullName').value.trim();
        const idNumber = document.getElementById('idNumber').value.trim();
        const contactNumber = document.getElementById('contactNumber').value.trim();
        const confirmationTick = document.getElementById('confirmationTick');
        const digitalSignature = document.getElementById('digitalSignature').value.trim();
        if(!confirmationTick.checked){ hideLoading(); await customAlert('Validation Error','You must tick the confirmation box.'); return; }
        if(digitalSignature!=='YES'){ hideLoading(); await customAlert('Validation Error','You must type YES for digital signature.'); return; }

        // Prepare data object (simplified for example)
        const data = { full_name: fullName, id_number: idNumber, contact_number: contactNumber, requested_amount: parseFloat(requestedAmount), date_submitted: new Date().toISOString(), status:'Pending Review' };
        const { error } = await supabase.from('borrowers').insert([data]);
        if(error){ throw error; }

        localStorage.removeItem('requestedLoanAmount');
        hideLoading();
        await customAlert('Success','Application submitted successfully.');
        goToPage('dashboard.html');
    } catch(e){
        hideLoading();
        console.error(e);
        await customAlert('Submission Failed', e.message || 'Unknown error occurred.');
    }
});
</script>
</body>
</html>
