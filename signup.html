<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Application Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  font-family: 'Inter', sans-serif;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  min-height: 100vh;
  background-color: #f7f9fb;
}
.container {
  max-width: 600px;
  width: 95%;
  padding: 2.5rem;
  margin-top: 2rem;
  margin-bottom: 4rem;
  background-color: #fff;
  border-radius: 0.75rem;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}
.form-group { margin-bottom: 1.25rem; }
label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #1f2937; text-align: left; }
.file-label-text { display: flex; justify-content: space-between; align-items: center; width: 100%; }
input[type="file"] { padding-top: 0.5rem; padding-bottom: 0.5rem; }
input[type="text"], input[type="number"], input[type="tel"], input[type="file"], select, textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  resize: vertical;
}
input:focus, select:focus, textarea:focus {
  border-color: #4f46e5;
  outline: 0;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}
.custom-modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex; justify-content: center; align-items: center;
  z-index: 1001; transition: opacity 0.3s;
}
.custom-modal-content {
  background: white; padding: 30px; border-radius: 12px;
  max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}
.loading-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background-color: rgba(255, 255, 255, 0.9);
  display: flex; justify-content: center; align-items: center;
  z-index: 100; flex-direction: column; text-align: center;
}
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #4f46e5;
  border-radius: 50%;
  width: 40px; height: 40px;
  animation: spin 1s linear infinite; margin-bottom: 1rem;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="custom-alert-modal" class="custom-modal hidden">
  <div class="custom-modal-content">
    <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Alert</h3>
    <div id="modal-message-container" class="text-gray-600 mb-6"><p id="modal-message"></p></div>
    <div class="flex space-x-3 mt-4">
      <button id="modal-cancel-button" class="w-1/2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline hidden">Cancel</button>
      <button id="modal-ok-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">OK</button>
    </div>
  </div>
</div>

<main class="container">
<header class="text-center mb-8">
  <h1 class="text-3xl font-bold text-gray-900">Loan Application Form</h1>
  <p class="text-gray-500 mt-2">Personal, Address, Employment, and Document Uploads</p>
</header>

<form id="loanApplicationForm" class="space-y-6">
<!-- Personal Details -->
<fieldset class="border p-4 rounded-lg shadow-sm">
  <legend class="text-lg font-semibold text-indigo-600 px-2">1. Personal Details</legend>
  <div class="form-group">
    <label for="fullName">Full Name</label>
    <input type="text" id="fullName" required placeholder="e.g., Jane Doe">
  </div>
  <div class="form-group">
    <label for="idNumber">South African ID Number</label>
    <input type="text" id="idNumber" required pattern="\d{13}" title="Must be a 13-digit ID number" placeholder="e.g., 9001015000087">
  </div>
  <div class="form-group">
    <label for="contactNumber">Contact Number</label>
    <input type="tel" id="contactNumber" required pattern="\d{10}" title="Must be a 10-digit phone number" placeholder="e.g., 0712345678">
  </div>
</fieldset>

<!-- Residential Address -->
<fieldset class="border p-4 rounded-lg shadow-sm">
  <legend class="text-lg font-semibold text-indigo-600 px-2">2. Residential Address</legend>
  <div class="form-group">
    <label for="residentialAddress">Physical Address (Must match Proof of Residence)</label>
    <textarea id="residentialAddress" rows="3" required placeholder="Street Address, Suburb, City, Postal Code"></textarea>
  </div>
</fieldset>

<!-- Employment Details -->
<fieldset class="border p-4 rounded-lg shadow-sm">
  <legend class="text-lg font-semibold text-indigo-600 px-2">3. Employment Details <span class="text-gray-500 text-sm">(Optional)</span></legend>
  <div class="form-group">
    <label for="employerName">Employer Name</label>
    <input type="text" id="employerName" placeholder="e.g., ABC Pty Ltd">
  </div>
  <div class="form-group">
    <label for="employeeAddress">Employee's Address</label>
    <textarea id="employeeAddress" rows="2" placeholder="e.g., 123 Main Street, Sandton"></textarea>
  </div>
</fieldset>

<!-- Payment Preference -->
<fieldset class="border p-4 rounded-lg shadow-sm">
  <legend class="text-lg font-semibold text-indigo-600 px-2">4. Payment Preference</legend>
  <div class="form-group">
    <label for="paymentMethod">How would you like to be paid?</label>
    <select id="paymentMethod" required class="cursor-pointer">
      <option value="" disabled selected>Select a payment method...</option>
      <option value="Bank Account">Bank Account (EFT)</option>
      <option value="Cardless Service">Cardless Service (Instant PIN)</option>
    </select>
  </div>
  <div id="paymentDetailsContainer" class="mt-4 p-4 border border-dashed border-gray-300 rounded-lg bg-gray-50 hidden">
    <p class="font-semibold text-gray-700 mb-1">Payment Details:</p>
  </div>
  <div class="mt-6 p-4 border border-blue-400 bg-blue-50 rounded-lg text-sm text-gray-700">
    <p class="font-bold mb-2 text-blue-800">For Loan Repayment/Settlement (EFT) Reference:</p>
    <ul class="list-disc list-inside space-y-1">
      <li>Account Name: Savings Account</li>
      <li>Bank: Capitec</li>
      <li>Account Number: 1213614048</li>
      <li>Branch Code: 470010</li>
      <li>REFERENCE: Your Name</li>
    </ul>
  </div>
</fieldset>

<!-- Required Documents -->
<fieldset class="border p-4 rounded-lg shadow-sm">
  <legend class="text-lg font-semibold text-indigo-600 px-2">5. Required Documents</legend>
  <p class="text-sm text-gray-600 mb-4">Please upload clear, legible copies (PDF or JPG format).</p>
  <div class="form-group">
    <label for="idDocument"><span class="file-label-text">Copy of ID Document <span class="text-red-500 font-bold">(Compulsory)</span></span></label>
    <input type="file" id="idDocument" accept=".pdf,.jpg,.jpeg" required>
  </div>
  <div class="form-group">
    <label for="bankStatement"><span class="file-label-text">Latest Bank Statement <span class="text-gray-500 font-medium">(Optional)</span></span></label>
    <input type="file" id="bankStatement" accept=".pdf,.jpg,.jpeg">
  </div>
  <div class="form-group">
    <label for="proofOfAddress"><span class="file-label-text">Proof of Residence (e.g., Utility Bill) <span class="text-red-500 font-bold">(Compulsory)</span></span></label>
    <input type="file" id="proofOfAddress" accept=".pdf,.jpg,.jpeg" required>
  </div>
  <div class="form-group">
    <label for="selfieDocument"><span class="file-label-text">Live Selfie <span class="text-red-500 font-bold">(Compulsory - Camera Only)</span></span></label>
    <input type="file" id="selfieDocument" accept="image/*" required capture="user">
  </div>
</fieldset>

<!-- Final Confirmation -->
<fieldset class="border p-4 rounded-lg shadow-sm bg-indigo-50">
  <legend class="text-lg font-semibold text-indigo-700 px-2">6. Final Confirmation</legend>
  <div class="form-group">
    <label class="flex items-start cursor-pointer p-3 border border-indigo-200 bg-white rounded-lg shadow-inner">
      <input type="checkbox" id="confirmationTick" required class="mt-1 mr-3 h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
      <span class="text-sm text-gray-800 font-medium">
        I confirm that all details provided in this loan application are true, accurate, and complete.
      </span>
    </label>
  </div>
  <div class="form-group mt-6">
    <label for="digitalSignature" class="block text-base font-bold text-gray-900 mb-2">Type "YES" to digitally sign the application</label>
    <input type="text" id="digitalSignature" required placeholder="Type YES in capital letters">
  </div>
</fieldset>

<button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-lg">Submit Application</button>
</form>

<div class="mt-8 text-center">
  <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Cancel and Go to Home</a>
</div>
</main>

<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loader"></div>
  <p id="loading-message" class="text-lg font-semibold text-indigo-700">Submitting your application and uploading documents...</p>
  <p class="text-sm text-gray-600 mt-2">This may take a moment. Please do not close the window.</p>
</div>

<script type="module">
// --- Firebase & Supabase Setup ---
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
let auth;

if (Object.keys(firebaseConfig).length > 0) {
  const app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  if (initialAuthToken) {
    signInWithCustomToken(auth, initialAuthToken).catch(e => {
      console.error("Firebase custom sign-in failed:", e);
      signInAnonymously(auth);
    });
  } else { signInAnonymously(auth); }
} else { console.warn("Firebase configuration not found. Skipping Firebase initialization."); }

const SUPABASE_URL = 'https://kujvvupdqvtkncolhcul.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1anZ2dXBkcXZ0a25jb2xoY3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDM0MzgsImV4cCI6MjA3OTM3OTQzOH0.VBnQywbTQwwWFLmjUAZggfIWC1_J5opHdFwyqMDD3QE';
export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- Utility Functions ---
function goToPage(page) { window.location.href = page; }

function customConfirmationAlert(title, messageHtml, okText = 'OK', cancelText = null) {
  const modal = document.getElementById('custom-alert-modal');
  document.getElementById('modal-title').textContent = title;
  const messageContainer = document.getElementById('modal-message-container');
  messageContainer.innerHTML = messageHtml;
  const okButton = document.getElementById('modal-ok-button');
  const cancelButton = document.getElementById('modal-cancel-button');
  okButton.textContent = okText;
  okButton.classList.remove('w-full', 'w-1/2');
  if (cancelText) {
    cancelButton.textContent = cancelText;
    cancelButton.classList.remove('hidden');
    okButton.classList.add('w-1/2');
    cancelButton.classList.add('w-1/2');
  } else {
    cancelButton.classList.add('hidden');
    okButton.classList.add('w-full');
  }
  modal.classList.remove('hidden');
  return new Promise(resolve => {
    const okHandler = () => {
      modal.classList.add('hidden');
      okButton.removeEventListener('click', okHandler);
      if (cancelText) cancelButton.removeEventListener('click', cancelHandler);
      resolve('ok');
    };
    const cancelHandler = () => {
      modal.classList.add('hidden');
      okButton.removeEventListener('click', okHandler);
      cancelButton.removeEventListener('click', cancelHandler);
      resolve('cancel');
    };
    okButton.addEventListener('click', okHandler);
    if (cancelText) cancelButton.addEventListener('click', cancelHandler);
  });
}

function customAlert(title, message) { return customConfirmationAlert(title, `<p>${message}</p>`, 'OK', null); }
function showLoading(message) { document.getElementById('loading-message').textContent = message; document.getElementById('loadingOverlay').classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); document.body.style.overflow = 'auto'; }
function calculateDueDate(submitDate) {
  const year = submitDate.getFullYear();
  const month = submitDate.getMonth();
  const lastDayOfMonth = new Date(year, month + 1, 0);
  const yyyy = lastDayOfMonth.getFullYear();
  const mm = String(lastDayOfMonth.getMonth() + 1).padStart(2, '0');
  const dd = String(lastDayOfMonth.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

async function uploadFile(file, bucket, path, isRequired = true) {
  if (!file) { if (isRequired) throw new Error("A compulsory file was not provided."); return null; }
  const { data, error } = await supabase.storage.from(bucket).upload(path, file, { cacheControl: '3600', upsert: false });
  if (error) throw new Error('File upload failed: ' + error.message);
  const { data: publicUrlData } = supabase.storage.from(bucket).getPublicUrl(data.path);
  if (!publicUrlData || !publicUrlData.publicUrl) throw new Error('Could not retrieve public URL after upload.');
  return publicUrlData.publicUrl;
}

function validateSouthAfricanId(idNumber) { return /^\d{13}$/.test(idNumber); }

// --- Dynamic Payment Fields ---
document.addEventListener('DOMContentLoaded', () => {
  const paymentMethod = document.getElementById('paymentMethod');
  const container = document.getElementById('paymentDetailsContainer');
  const fields = {
    'Bank Account': `<div class="form-group"><label for="bankName">Bank Name</label><input type="text" id="bankName" required placeholder="e.g., FNB, Standard Bank"></div>
                     <div class="form-group"><label for="bankAccountNumber">Bank Account Number</label><input type="text" id="bankAccountNumber" required pattern="\\d+" placeholder="e.g., 1234567890"></div>`,
    'Cardless Service': `<div class="form-group"><label for="cardlessBank">Preferred Cardless Bank</label><input type="text" id="cardlessBank" required placeholder="e.g., Capitec"></div>
                         <div class="form-group"><label for="cardlessPhone">Phone Number</label><input type="tel" id="cardlessPhone" required pattern="\\d{10}" placeholder="e.g., 0712345678"></div>`
  };
  paymentMethod.addEventListener('change', (e) => {
    const val = e.target.value;
    if (fields[val]) { container.innerHTML = `<p class="font-semibold text-gray-700 mb-1">Payment Details:</p>` + fields[val]; container.classList.remove('hidden'); }
    else container.classList.add('hidden');
  });
});

// --- Form Submission ---
document.getElementById('loanApplicationForm').addEventListener('submit', async (event) => {
  event.preventDefault();
  const form = event.target;
  const signature = document.getElementById('digitalSignature').value.trim();
  if (signature !== 'YES') { await customAlert('Validation Error', 'You must type YES to digitally sign the application.'); return; }

  try {
    showLoading('Submitting your application and uploading documents...');
    const idFile = document.getElementById('idDocument').files[0];
    const bankStatementFile = document.getElementById('bankStatement').files[0];
    const proofFile = document.getElementById('proofOfAddress').files[0];
    const selfieFile = document.getElementById('selfieDocument').files[0];

    const timestamp = Date.now();
    const idUrl = await uploadFile(idFile, 'documents', `id_${timestamp}_${idFile.name}`);
    const bankUrl = bankStatementFile ? await uploadFile(bankStatementFile, 'documents', `bank_${timestamp}_${bankStatementFile.name}`, false) : null;
    const proofUrl = await uploadFile(proofFile, 'documents', `proof_${timestamp}_${proofFile.name}`);
    const selfieUrl = await uploadFile(selfieFile, 'documents', `selfie_${timestamp}_${selfieFile.name}`);

    const data = {
      fullName: document.getElementById('fullName').value,
      idNumber: document.getElementById('idNumber').value,
      contactNumber: document.getElementById('contactNumber').value,
      residentialAddress: document.getElementById('residentialAddress').value,
      employerName: document.getElementById('employerName').value,
      employeeAddress: document.getElementById('employeeAddress').value,
      paymentMethod: document.getElementById('paymentMethod').value,
      digitalSignature: signature,
      documentUrls: { idUrl, bankUrl, proofUrl, selfieUrl },
      submittedAt: new Date().toISOString(),
      repaymentDueDate: calculateDueDate(new Date())
    };

    const { data: dbData, error } = await supabase.from('loan_applications').insert([data]);
    hideLoading();
    if (error) throw error;
    await customAlert('Success', 'Your loan application has been successfully submitted.');
    form.reset();
    document.getElementById('paymentDetailsContainer').classList.add('hidden');
    // âœ… Automatic redirect to dashboard after success
    window.location.href = 'dashboard.html'; // change to your actual dashboard URL
  } catch (error) {
    hideLoading();
    await customAlert('Error', 'Submission Failed: ' + error.message);
  }
});
</script>
</body>
</html>
